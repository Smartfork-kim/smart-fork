<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌîÑÎ¶¨ÏÖÄ - ÏõπÍ≤åÏûÑ Î™®Ïùå</title>
    <style>
        :root {
            --card-width: 140px;
            --card-height: 195px;
            --cell-width: 140px;
            --cell-height: 195px;
            --column-gap: 18px;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #0F4C75 0%, #3282B8 100%);
            min-height: 100vh;
            color: white;
            user-select: none;
            overflow-x: auto;
        }
        
        .mobile-landscape-notice {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .notice-content {
            text-align: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .rotate-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: rotate 2s infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(90deg); }
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            width: calc(8 * var(--card-width) + 7 * var(--column-gap) + 40px);
            margin-left: auto;
            margin-right: auto;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .game-title {
            font-size: 2.5rem;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .game-board {
            max-width: calc(8 * var(--card-width) + 7 * var(--column-gap) + 40px);
            margin: 50px auto 0 auto;
            box-sizing: border-box;
        }
        
        .top-area {
            display: flex;
            justify-content: center;
            gap: var(--column-gap);
            margin-bottom: 45px;
            width: calc(8 * var(--card-width) + 7 * var(--column-gap) + 40px);
            height: var(--cell-height);
            margin-left: auto;
            margin-right: auto;
            position: relative;
            box-sizing: border-box;
        }
        
        .free-cells, .home-cells {
            display: flex;
            gap: var(--column-gap);
        }
        
        .cell {
            width: var(--cell-width);
            height: var(--cell-height);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.5);   
        }
        
        .cell.drop-target {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.3);
        }
        
        .play-area {
            display: flex;
            justify-content: center;  
            width: calc(8 * var(--card-width) + 7 * var(--column-gap)+ 40px);
            gap : calc(var(--column-gap) + 4px);
            
        }
        
        .column {
            min-height: 600px;
            width: var(--card-width);
            position: relative;
            padding: 3px 0 8px 0;
            
        }
        

        
        .card {
            width: calc(var(--card-width));
            height: calc(var(--card-height));
            border-radius: 12px;
            cursor: grab;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }
        
        
        .cell .card {
            position: relative;
            margin: 0;
        }
        
        .card:active {
            cursor: grabbing;
        }
        
        .card.dragging {
            position: fixed !important;
            transform: scale(1.05) !important;
            opacity: 0.9 !important;
            pointer-events: none !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6) !important;
            z-index: 9999 !important;
            transition: none !important;
        }
        
        .card img {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .win-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 24px;
            display: none;
            z-index: 2000;
        }
        

        
        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 1200px) {
            :root {
                --card-width: 120px;
                --card-height: 167px;
                --cell-width: 120px;
                --cell-height: 167px;
                --column-gap: 15px;
            }
        }
        
        @media (max-width: 900px) {
            :root {
                --card-width: 100px;
                --card-height: 139px;
                --cell-width: 100px;
                --cell-height: 139px;
                --column-gap: 12px;
            }
            
            .game-title {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 768px) {
            :root {
                --card-width: 80px;
                --card-height: 111px;
                --cell-width: 80px;
                --cell-height: 111px;
                --column-gap: 8px;
            }
            
            .mobile-landscape-notice {
                display: flex;
            }
            
            .game-title {
                font-size: 1.5rem;
            }
            
            .cell {
                font-size: 14px;
            }
        }
        
        @media (max-width: 600px) {
            :root {
                --card-width: 70px;
                --card-height: 97px;
                --cell-width: 70px;
                --cell-height: 97px;
                --column-gap: 6px;
            }
            
            .game-title {
                font-size: 1.3rem;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        
        @media (orientation: landscape) and (max-width: 768px) {
            .mobile-landscape-notice {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-landscape-notice">
        <div class="notice-content">
            <div class="rotate-icon">üì±</div>
            <p>Î™®Î∞îÏùºÏóêÏÑúÎäî Í∞ÄÎ°úÎ°ú ÌîåÎ†àÏù¥Ìï¥Ï£ºÏÑ∏Ïöî!</p>
        </div>
    </div>

    <div class="header">
        <a href="../index.html" class="back-btn">‚Üê Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
        <h1 class="game-title">
            <span style="color: #e74c3c; font-size: 2.5rem; margin-right: 15px;">‚ô•‚ô¶</span>
            <span style="font-size: 2.5rem;">ÌîÑÎ¶¨ÏÖÄ</span>
            <span style="color: #2c3e50; font-size: 2.5rem; margin-left: 15px;">‚ô£‚ô†</span>
        </h1>
        <div class="controls">
            <button class="btn" onclick="newGame()">ÏÉà Í≤åÏûÑ</button>
            <button class="btn" onclick="autoMove()">ÏûêÎèô Ïù¥Îèô</button>
        </div>
    </div>
    

    
    <div class="game-board">
        <div class="top-area">
            <div class="free-cells">
                <div class="cell" data-type="freecell" data-index="0"></div>
                <div class="cell" data-type="freecell" data-index="1"></div>
                <div class="cell" data-type="freecell" data-index="2"></div>
                <div class="cell" data-type="freecell" data-index="3"></div>
            </div>
            <div class="home-cells">
                <div class="cell" data-type="home" data-suit="hearts"></div>
                <div class="cell" data-type="home" data-suit="diamonds"></div>
                <div class="cell" data-type="home" data-suit="clubs"></div>
                <div class="cell" data-type="home" data-suit="spades"></div>
            </div>
        </div>
        
        <div class="play-area">
            <div class="column" data-column="0"></div>
            <div class="column" data-column="1"></div>
            <div class="column" data-column="2"></div>
            <div class="column" data-column="3"></div>
            <div class="column" data-column="4"></div>
            <div class="column" data-column="5"></div>
            <div class="column" data-column="6"></div>
            <div class="column" data-column="7"></div>
        </div>
    </div>
    
    <div class="win-message" id="winMessage">
        <div>üéâ Ï∂ïÌïòÌï©ÎãàÎã§! üéâ</div>
        <div>ÌîÑÎ¶¨ÏÖÄÏùÑ ÌÅ¥Î¶¨Ïñ¥ÌñàÏäµÎãàÎã§!</div>
        <button class="btn" onclick="newGame()" style="margin-top: 20px;">ÏÉà Í≤åÏûÑ ÏãúÏûë</button>
    </div>

    <script>
                class FreeCell {
            constructor() {
                this.freeCells = [null, null, null, null];
                this.homeCells = {hearts: [], diamonds: [], clubs: [], spades: []};
                this.columns = [[], [], [], [], [], [], [], []];
                this.isDragging = false;
                this.dragPrepared = false;
                this.draggedCard = null;
                this.draggedCardElements = [];
                this.draggedCardsData = [];
                this.draggedFrom = null;
                this.dragOffsetX = 0;
                this.dragOffsetY = 0;
                this.isAutoCompleting = false;
                this.cardValues = {
                    'ace': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
                    'jack': 11, 'queen': 12, 'king': 13
                };
                
                            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Î≥ÄÏàòÎì§
            this.touchStartTime = 0;
            this.touchStartX = 0;
            this.touchStartY = 0;
            this.isTouchDragging = false;
            this.dragPreview = null;
            this.lastTapTime = 0;
            this.lastTapCard = null;
            this.lastTapPosition = null;
            this.tapCount = 0;
                
                this.init();
            }
            
            init() {
                this.createAndDealCards();
                this.render();
                this.setupEventListeners();
            }
            
            createAndDealCards() {
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                const values = ['ace', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'jack', 'queen', 'king'];
                const cards = [];
                
                // Ïπ¥Îìú ÏÉùÏÑ±
                for (let suit of suits) {
                    for (let value of values) {
                        cards.push({
                            suit: suit,
                            value: value,
                            color: suit === 'hearts' || suit === 'diamonds' ? 'red' : 'black',
                            number: this.cardValues[value]
                        });
                    }
                }
                
                // Ïπ¥Îìú ÏÑûÍ∏∞
                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }
                
                // Ïπ¥Îìú Î∞∞Ïπò
                let cardIndex = 0;
                for (let col = 0; col < 8; col++) {
                    const cardsInColumn = col < 4 ? 7 : 6;
                    for (let row = 0; row < cardsInColumn; row++) {
                        this.columns[col].push(cards[cardIndex]);
                        cardIndex++;
                    }
                }
            }
            
            setupEventListeners() {
                // Í∏∞Î≥∏ ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏
                document.addEventListener('mousedown', this.handleMouseDown.bind(this));
                document.addEventListener('mousemove', this.handleMouseMove.bind(this));
                document.addEventListener('mouseup', this.handleMouseUp.bind(this));
                document.addEventListener('dblclick', this.handleDoubleClickEvent.bind(this));
                
                // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
                document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
                
            }
            

            
            handleMouseDown(e) {
                const card = e.target.closest('.card');
                if (!card) return;
                
                const position = this.findCardPosition(card);
                if (!position) return;
                
                if (!this.canPickUpCard(position)) return;
                
                // ÌÅ¥Î¶≠Ìïú Ïπ¥ÎìúÏùò ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞
                const cardRect = card.getBoundingClientRect();
                
                // ÎßàÏö∞Ïä§ ÌÅ¥Î¶≠ ÏúÑÏπòÏôÄ Ïπ¥Îìú Ï¢åÏÉÅÎã®Ïùò Ïò§ÌîÑÏÖã Í≥ÑÏÇ∞ (Îã®ÏàúÌôî)
                this.dragOffsetX = e.clientX - cardRect.left;
                this.dragOffsetY = e.clientY - cardRect.top;
                
                // ÎìúÎûòÍ∑∏ Ï§ÄÎπÑÎßå ÌïòÍ≥† Ïã§Ï†ú ÏãúÏûëÏùÄ mousemoveÏóêÏÑú (ÎçîÎ∏îÌÅ¥Î¶≠ÏùÑ ÏúÑÌï¥)
                this.dragPrepared = true;
                this.draggedCard = card;
                this.draggedFrom = position;
                this.draggedCardsData = this.getCardFromPosition(position);
                
                e.preventDefault();
            }
            
            // ÌÑ∞Ïπò ÏãúÏûë
            handleTouchStart(e) {
                e.preventDefault();
                const card = e.target.closest('.card');
                if (!card) return;
                
                const touch = e.touches[0];
                this.touchStartTime = Date.now();
                this.touchStartX = touch.clientX;
                this.touchStartY = touch.clientY;
                
                const position = this.findCardPosition(card);
                if (!position) return;
                
                if (!this.canPickUpCard(position)) return;
                
                // PCÏ≤òÎüº ÌÑ∞Ïπò Ïò§ÌîÑÏÖã Í≥ÑÏÇ∞
                const cardRect = card.getBoundingClientRect();
                this.dragOffsetX = touch.clientX - cardRect.left;
                this.dragOffsetY = touch.clientY - cardRect.top;
                
                // ÎìúÎûòÍ∑∏ Ï§ÄÎπÑ
                this.dragPrepared = true;
                this.draggedCard = card;
                this.draggedFrom = position;
                this.draggedCardsData = this.getCardFromPosition(position);
                
                // ÎìúÎûòÍ∑∏ ÌîÑÎ¶¨Î∑∞ ÏÉùÏÑ±
                this.createDragPreview(card, this.draggedCardsData[0]);
            }
            
            // ÎìúÎûòÍ∑∏ ÌîÑÎ¶¨Î∑∞ ÏÉùÏÑ±
            createDragPreview(originalCard, cardData) {
                // Í∏∞Ï°¥ ÌîÑÎ¶¨Î∑∞ Ï†úÍ±∞
                if (this.dragPreview) {
                    document.body.removeChild(this.dragPreview);
                }
                
                // ÏÉàÎ°úÏö¥ ÌîÑÎ¶¨Î∑∞ ÏÉùÏÑ±
                this.dragPreview = originalCard.cloneNode(true);
                this.dragPreview.style.position = 'fixed';
                this.dragPreview.style.pointerEvents = 'none';
                this.dragPreview.style.zIndex = '10000';
                this.dragPreview.style.opacity = '0.8';
                this.dragPreview.style.transform = 'scale(1.05)';
                this.dragPreview.style.transition = 'none';
                this.dragPreview.classList.add('drag-preview');
                
                // ÏõêÎ≥∏ Ïπ¥ÎìúÏùò ÏúÑÏπòÎ•º Í∏∞Ï§ÄÏúºÎ°ú Ï¥àÍ∏∞ ÏúÑÏπò ÏÑ§Ï†ï
                const rect = originalCard.getBoundingClientRect();
                this.dragPreview.style.left = rect.left + 'px';
                this.dragPreview.style.top = rect.top + 'px';
                
                document.body.appendChild(this.dragPreview);
            }
            
            startDragging() {
                const position = this.draggedFrom;
                const card = this.draggedCard;
                
                // Ïó¨Îü¨ Ïπ¥ÎìúÎ•º ÎìúÎûòÍ∑∏Ìï† Í≤ΩÏö∞ DOM ÏöîÏÜåÎì§ Ï∞æÍ∏∞
                this.draggedCardElements = [];
                
                if (position.type === 'column') {
                    // Ïª¨ÎüºÏóêÏÑú Ïó¨Îü¨ Ïû• ÏÑ†ÌÉùÎêú Í≤ΩÏö∞
                    const column = document.querySelector(`[data-column="${position.column}"]`);
                    const allCardElements = Array.from(column.querySelectorAll('.card'));
                    
                    // ÏÑ†ÌÉùÎêú Ïπ¥ÎìúÎì§Ïùò ÏãúÏûë Ïù∏Îç±Ïä§
                    const startIndex = this.columns[position.column].length - this.draggedCardsData.length;
                    
                    // ÏÑ†ÌÉùÎêú Ïπ¥ÎìúÎì§Ïùò DOM ÏöîÏÜåÎì§ ÏàòÏßë
                    for (let i = 0; i < this.draggedCardsData.length; i++) {
                        const cardElement = allCardElements[startIndex + i];
                        if (cardElement) {
                            this.draggedCardElements.push(cardElement);
                            
                            // ÌòÑÏû¨ ÏúÑÏπòÎ•º Ï†ïÌôïÌûà Í≥ÑÏÇ∞ÌïòÏó¨ fixedÎ°ú Ï†ÑÌôò
                            const rect = cardElement.getBoundingClientRect();
                            
                            // Í∏∞Ï°¥ Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Ï†úÍ±∞ ÌõÑ Ï†ïÌôïÌïú ÏúÑÏπò ÏÑ§Ï†ï
                            cardElement.style.removeProperty('left');
                            cardElement.style.removeProperty('transform');
                            cardElement.style.position = 'fixed';
                            cardElement.style.left = rect.left + 'px';
                            cardElement.style.top = rect.top + 'px';
                            cardElement.style.transform = 'scale(1.05)';
                            cardElement.style.zIndex = (9999 + i).toString();
                            cardElement.classList.add('dragging');
                        }
                    }
                } else {
                    // ÌîÑÎ¶¨ÏÖÄÏù¥ÎÇò ÌôàÏÖÄÏùò Í≤ΩÏö∞ Îã®Ïùº Ïπ¥Îìú
                    this.draggedCardElements.push(card);
                    
                    // ÌòÑÏû¨ ÏúÑÏπòÎ•º Ï†ïÌôïÌûà Í≥ÑÏÇ∞ÌïòÏó¨ fixedÎ°ú Ï†ÑÌôò
                    const rect = card.getBoundingClientRect();
                    
                    // Í∏∞Ï°¥ Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Ï†úÍ±∞ ÌõÑ Ï†ïÌôïÌïú ÏúÑÏπò ÏÑ§Ï†ï
                    card.style.removeProperty('left');
                    card.style.removeProperty('transform');
                    card.style.position = 'fixed';
                    card.style.left = rect.left + 'px';
                    card.style.top = rect.top + 'px';
                    card.style.transform = 'scale(1.1)';
                    card.style.zIndex = '9999';
                    card.classList.add('dragging');
                }
                
            }
            
            handleMouseMove(e) {
                // ÎìúÎûòÍ∑∏ Ï§ÄÎπÑ ÏÉÅÌÉúÏóêÏÑú Ïã§Ï†ú ÎìúÎûòÍ∑∏ ÏãúÏûë
                if (this.dragPrepared && !this.isDragging) {
                    this.isDragging = true;
                    this.dragPrepared = false;
                    this.startDragging();
                }
                
                if (!this.isDragging || !this.draggedCard) return;
                
                // Ïò§ÌîÑÏÖãÏùÑ Í≥†Î†§Ìïú Ïπ¥Îìú ÏúÑÏπò Í≥ÑÏÇ∞ (Îã®ÏàúÌôî)
                const baseX = e.clientX - this.dragOffsetX;
                const baseY = e.clientY - this.dragOffsetY;
                
                // Î™®Îì† ÏÑ†ÌÉùÎêú Ïπ¥ÎìúÎì§ÏùÑ Ìï®Íªò Ïù¥Îèô (ÏõêÎûò Í∞ÑÍ≤© Ïú†ÏßÄ)
                this.draggedCardElements.forEach((cardElement, index) => {
                    cardElement.style.position = 'fixed';
                    cardElement.style.left = baseX + 'px';
                    cardElement.style.top = (baseY + index * 30) + 'px'; // ÏõêÎûò Ïª¨Îüº Í∞ÑÍ≤©(30px) Ïú†ÏßÄ
                    cardElement.style.transform = 'scale(1.05)';
                    cardElement.style.pointerEvents = 'none';
                });
                
                e.preventDefault();
            }
            
            // ÌÑ∞Ïπò Ïù¥Îèô
            handleTouchMove(e) {
                e.preventDefault();
                
                if (!this.draggedCard || !this.dragPreview) return;
                
                const touch = e.touches[0];
                const touchDistance = Math.sqrt(
                    Math.pow(touch.clientX - this.touchStartX, 2) + 
                    Math.pow(touch.clientY - this.touchStartY, 2)
                );
                
                // ÏµúÏÜå ÎìúÎûòÍ∑∏ Í±∞Î¶¨ ÌôïÏù∏
                if (touchDistance > 10) {
                    this.isTouchDragging = true;
                    
                    // PCÏ≤òÎüº Ïò§ÌîÑÏÖãÏùÑ Í≥†Î†§Ìïú ÎìúÎûòÍ∑∏ ÌîÑÎ¶¨Î∑∞ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                    const baseX = touch.clientX - this.dragOffsetX;
                    const baseY = touch.clientY - this.dragOffsetY;
                    this.dragPreview.style.left = baseX + 'px';
                    this.dragPreview.style.top = baseY + 'px';
                    
                    // ÌÑ∞Ïπò ÏúÑÏπòÏùò ÏöîÏÜå Ï∞æÍ∏∞
                    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropTarget = elementBelow ? elementBelow.closest('.cell, .column') : null;
                    
                    // Î™®Îì† ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
                    document.querySelectorAll('.cell, .column').forEach(el => {
                        el.classList.remove('drop-target');
                    });
                    
                    // Ïú†Ìö®Ìïú ÎìúÎ°≠ ÏúÑÏπòÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥† ÌïòÏù¥ÎùºÏù¥Ìä∏
                    if (dropTarget && this.canDropCard(this.draggedFrom, this.getDropTarget(dropTarget))) {
                        dropTarget.classList.add('drop-target');
                    }
                }
            }
            
            handleMouseUp(e) {
                // ÎìúÎûòÍ∑∏ Ï§ÄÎπÑÎßå ÌïòÍ≥† Ïã§Ï†ú ÎìúÎûòÍ∑∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ (ÌÅ¥Î¶≠ ÎòêÎäî ÎçîÎ∏îÌÅ¥Î¶≠)
                if (this.dragPrepared && !this.isDragging) {
                    this.dragPrepared = false;
                    this.draggedCard = null;
                    this.draggedFrom = null;
                    this.draggedCardsData = [];
                    return;
                }
                
                if (!this.isDragging || !this.draggedCard) return;
                
                const target = this.findDropTarget(e.clientX, e.clientY);
                
                if (target && this.canDropCard(this.draggedFrom, target)) {
                    this.moveCard(this.draggedFrom, target);
                }
                
                // Î™®Îì† ÎìúÎûòÍ∑∏Îêú Ïπ¥ÎìúÎì§Ïùò Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
                this.draggedCardElements.forEach(cardElement => {
                    cardElement.style.removeProperty('position');
                    cardElement.style.removeProperty('left');
                    cardElement.style.removeProperty('top');
                    cardElement.style.removeProperty('transform');
                    cardElement.style.removeProperty('z-index');
                    cardElement.style.removeProperty('pointer-events');
                    cardElement.classList.remove('dragging');
                });
                
                // ÎìúÎûòÍ∑∏ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                this.isDragging = false;
                this.dragPrepared = false;
                this.draggedCard = null;
                this.draggedCardElements = [];
                this.draggedCardsData = [];
                this.draggedFrom = null;
                this.dragOffsetX = 0;
                this.dragOffsetY = 0;
                
                // ÌôîÎ©¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞
                this.render();
                this.checkAutoComplete();
                this.checkWin();
                
                e.preventDefault();
            }
            
            // ÌÑ∞Ïπò Ï¢ÖÎ£å
            handleTouchEnd(e) {
                e.preventDefault();
                
                if (!this.draggedCard) return;
                
                const touch = e.changedTouches[0];
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - this.touchStartTime;
                const touchDistance = Math.sqrt(
                    Math.pow(touch.clientX - this.touchStartX, 2) + 
                    Math.pow(touch.clientY - this.touchStartY, 2)
                );
                
                // ÎìúÎûòÍ∑∏ ÌîÑÎ¶¨Î∑∞ Ï†úÍ±∞
                if (this.dragPreview) {
                    document.body.removeChild(this.dragPreview);
                    this.dragPreview = null;
                }
                
                // ÎìúÎûòÍ∑∏ Ï§ëÏù¥ÏóàÎã§Î©¥ ÎìúÎ°≠ Ï≤òÎ¶¨
                if (this.isTouchDragging && touchDistance > 10) {
                    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropTarget = elementBelow ? elementBelow.closest('.cell, .column') : null;
                    
                    if (dropTarget) {
                        const target = this.getDropTarget(dropTarget);
                        if (target && this.canDropCard(this.draggedFrom, target)) {
                            this.moveCard(this.draggedFrom, target);
                        }
                    }
                } else if (touchDuration < 300 && touchDistance < 10) {
                    // ÏßßÏùÄ ÌÑ∞Ïπò (ÎçîÎ∏îÌÉ≠ ÌôïÏù∏)
                    this.handleSingleTap(e);
                }
                // ÎçîÎ∏îÌÉ≠ÏùÄ dblclick Ïù¥Î≤§Ìä∏Î°ú Ï≤òÎ¶¨
                
                // ÎìúÎûòÍ∑∏ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                this.isTouchDragging = false;
                this.dragPrepared = false;
                this.draggedCard = null;
                this.draggedFrom = null;
                this.draggedCardsData = [];
                
                // Î™®Îì† ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
                document.querySelectorAll('.cell, .column').forEach(el => {
                    el.classList.remove('drop-target');
                });
                
                // ÌôîÎ©¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞
                this.render();
                this.checkAutoComplete();
                this.checkWin();
            }
            
            // Îã®Ïùº ÌÉ≠ Ï≤òÎ¶¨ (Î™®Î∞îÏùº ÎçîÎ∏îÌÉ≠ Í∞êÏßÄÏö©)
            handleSingleTap(e) {
                console.log('Single tap detected');
                const touch = e.changedTouches[0];
                const clickX = touch.clientX;
                const clickY = touch.clientY;
                
                // Ïª¨ÎüºÏóêÏÑú ÌÅ¥Î¶≠Ìïú Ïπ¥Îìú Ï∞æÍ∏∞ (PCÏôÄ ÎèôÏùºÌïú Î∞©Ïãù)
                const columns = document.querySelectorAll('.column');
                let clickedCard = null;
                let clickedPosition = null;
                
                for (let column of columns) {
                    const cards = Array.from(column.querySelectorAll('.card'));
                    for (let i = cards.length - 1; i >= 0; i--) {
                        const cardElement = cards[i];
                        const rect = cardElement.getBoundingClientRect();
                        if (clickX >= rect.left && clickX <= rect.right && 
                            clickY >= rect.top && clickY <= rect.bottom) {
                            clickedCard = cardElement;
                            const columnIndex = parseInt(column.dataset.column);
                            clickedPosition = {type: 'column', column: columnIndex, row: i};
                            break;
                        }
                    }
                    if (clickedCard) break;
                }
                
                // Ïª¨ÎüºÏóêÏÑú Î™ª Ï∞æÏïòÏúºÎ©¥ ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Ï∞æÍ∏∞
                if (!clickedCard) {
                    const freecells = document.querySelectorAll('.cell[data-type="freecell"]');
                    for (let cell of freecells) {
                        const cardElement = cell.querySelector('.card');
                        if (cardElement) {
                            const rect = cardElement.getBoundingClientRect();
                            if (clickX >= rect.left && clickX <= rect.right && 
                                clickY >= rect.top && clickY <= rect.bottom) {
                                clickedCard = cardElement;
                                const index = parseInt(cell.dataset.index);
                                clickedPosition = {type: 'freecell', index: index};
                                break;
                            }
                        }
                    }
                }
                
                if (clickedCard && clickedPosition) {
                    const currentTime = Date.now();
                    const timeDiff = currentTime - this.lastTapTime;
                    
                    console.log('Tap info:', {
                        lastTapTime: this.lastTapTime,
                        currentTime: currentTime,
                        timeDiff: timeDiff,
                        lastTapCard: this.lastTapCard,
                        clickedCard: clickedCard,
                        isSameCard: this.lastTapCard === clickedCard,
                        isWithinTime: timeDiff < 300
                    });
                    
                    // Í∞ôÏùÄ Ïπ¥ÎìúÏóê ÎåÄÌïú Îëê Î≤àÏß∏ ÌÉ≠Ïù∏ÏßÄ ÌôïÏù∏ (300ms Ïù¥ÎÇ¥)
                    // Ïπ¥Îìú ÏúÑÏπò Ï†ïÎ≥¥Î°ú ÎπÑÍµê
                    const isSameCard = this.lastTapCard && clickedCard && 
                                     JSON.stringify(clickedPosition) === JSON.stringify(this.lastTapPosition);
                    if (isSameCard && timeDiff < 300) {
                        console.log('Double tap detected!');
                        // ÎçîÎ∏îÌÉ≠ Î∞úÏÉù! PCÏôÄ ÎèôÏùºÌïú Ìï®Ïàò Ìò∏Ï∂ú
                        this.lastTapTime = 0;
                        this.lastTapCard = null;
                        this.lastTapPosition = null;
                        
                        // Î™®Î∞îÏùºÏóêÏÑúÎäî Ïù¥ÎØ∏ Ï∞æÏùÄ Ïπ¥ÎìúÏôÄ ÏúÑÏπòÎ•º ÏßÅÏ†ë ÏÇ¨Ïö©
                        this.handleDoubleClick(e, clickedCard, clickedPosition);
                    } else {
                        console.log('First tap recorded');
                        // Ï≤´ Î≤àÏß∏ ÌÉ≠ Í∏∞Î°ù
                        this.lastTapTime = currentTime;
                        this.lastTapCard = clickedCard;
                        this.lastTapPosition = clickedPosition;
                    }
                }
            }
            
            // ÎìúÎ°≠ ÌÉÄÍ≤ü Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            getDropTarget(element) {
                if (element.classList.contains('cell')) {
                    const type = element.dataset.type;
                    const index = element.dataset.index ? parseInt(element.dataset.index) : element.dataset.suit;
                    return { type, index };
                } else if (element.classList.contains('column')) {
                    return { type: 'column', index: parseInt(element.dataset.column) };
                }
                return null;
            }

            handleDoubleClickEvent(e) {
                console.log('=== PC ÎçîÎ∏îÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏãúÏûë ===');
                console.log('Double click/tap detected!', e.type);
                const card = e.target.closest('.card');
                if (!card) {
                    console.log('‚ùå Ïπ¥ÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                    return;
                }
                console.log('‚úÖ Ïπ¥Îìú ÏöîÏÜå Ï∞æÏùå:', card);
                
                // ÌÅ¥Î¶≠Ìïú Ï†ïÌôïÌïú ÏúÑÏπòÏóêÏÑú Ïπ¥Îìú Ï∞æÍ∏∞
                const clickX = e.clientX;
                const clickY = e.clientY;
                console.log('ÌÅ¥Î¶≠ ÏúÑÏπò:', { x: clickX, y: clickY });
                
                // Ïª¨ÎüºÏóêÏÑú ÌÅ¥Î¶≠Ìïú Ïπ¥Îìú Ï∞æÍ∏∞ (Ïö∞ÏÑ†ÏàúÏúÑ)
                const columns = document.querySelectorAll('.column');
                console.log('Ïª¨Îüº Í∞úÏàò:', columns.length);
                let clickedCard = null;
                let clickedPosition = null;
                
                for (let column of columns) {
                    const cards = Array.from(column.querySelectorAll('.card'));
                    for (let i = cards.length - 1; i >= 0; i--) {
                        const cardElement = cards[i];
                        const rect = cardElement.getBoundingClientRect();
                        if (clickX >= rect.left && clickX <= rect.right && 
                            clickY >= rect.top && clickY <= rect.bottom) {
                            clickedCard = cardElement;
                            const columnIndex = parseInt(column.dataset.column);
                            clickedPosition = {type: 'column', column: columnIndex, row: i};
                            break;
                        }
                    }
                    if (clickedCard) break;
                }
                
                // Ïª¨ÎüºÏóêÏÑú Î™ª Ï∞æÏïòÏúºÎ©¥ ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Ï∞æÍ∏∞
                if (!clickedCard) {
                    const freecells = document.querySelectorAll('.cell[data-type="freecell"]');
                    for (let cell of freecells) {
                        const cardElement = cell.querySelector('.card');
                        if (cardElement) {
                            const rect = cardElement.getBoundingClientRect();
                            if (clickX >= rect.left && clickX <= rect.right && 
                                clickY >= rect.top && clickY <= rect.bottom) {
                                clickedCard = cardElement;
                                const index = parseInt(cell.dataset.index);
                                clickedPosition = {type: 'freecell', index: index};
                                break;
                            }
                        }
                    }
                }
                
                if (clickedCard && clickedPosition) {
                    console.log('‚úÖ handleDoubleClick Ìò∏Ï∂ú:', { card: clickedCard, position: clickedPosition });
                    this.handleDoubleClick(e, clickedCard, clickedPosition);
                } else {
                    console.log('‚ùå ÌÅ¥Î¶≠Ìïú Ïπ¥ÎìúÎÇò ÏúÑÏπòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                e.preventDefault();
                e.stopPropagation();
            }
            
            handleDoubleClick(e, card, position) {
                console.log('=== handleDoubleClick Ìï®Ïàò ÏãúÏûë ===');
                console.log('ÏûÖÎ†• ÌååÎùºÎØ∏ÌÑ∞:', { card, position });
                
                // ÎìúÎûòÍ∑∏ Ï§ÄÎπÑ/ÏßÑÌñâ ÏÉÅÌÉú ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî (ÎçîÎ∏îÌÅ¥Î¶≠Í≥º ÎìúÎûòÍ∑∏ Ï∂©Îèå Î∞©ÏßÄ)
                this.dragPrepared = false;
                this.isDragging = false;
                this.isTouchDragging = false;
                
                // ÎìúÎûòÍ∑∏ ÌîÑÎ¶¨Î∑∞ Ï†úÍ±∞
                if (this.dragPreview) {
                    document.body.removeChild(this.dragPreview);
                    this.dragPreview = null;
                }
                
                if (this.draggedCard) {
                    if (this.draggedCardElements.length > 0) {
                        this.draggedCardElements.forEach(cardElement => {
                            cardElement.classList.remove('dragging');
                            cardElement.style.removeProperty('position');
                            cardElement.style.removeProperty('left');
                            cardElement.style.removeProperty('top');
                            cardElement.style.removeProperty('transform');
                            cardElement.style.removeProperty('z-index');
                            cardElement.style.removeProperty('pointer-events');
                        });
                    } else {
                        this.draggedCard.classList.remove('dragging');
                        this.draggedCard.style.removeProperty('position');
                        this.draggedCard.style.removeProperty('left');
                        this.draggedCard.style.removeProperty('top');
                        this.draggedCard.style.removeProperty('transform');
                        this.draggedCard.style.removeProperty('z-index');
                        this.draggedCard.style.removeProperty('pointer-events');
                    }
                    this.clearDropTargets();
                    this.draggedCard = null;
                    this.draggedCardElements = [];
                    this.draggedCardsData = [];
                    this.draggedFrom = null;
                    this.dragOffsetX = 0;
                    this.dragOffsetY = 0;
                }
                
                if (!position) {
                    console.log('‚ùå positionÏù¥ ÏóÜÏùå');
                    return;
                }
                
                // Ïó¨Îü¨ Ïπ¥Îìú ÏÑ†ÌÉùÏùÄ ÎçîÎ∏îÌÅ¥Î¶≠ÏúºÎ°ú Ïù¥Îèô Î∂àÍ∞Ä
                const cards = this.getCardFromPosition(position);
                console.log('Ïπ¥Îìú Î∞∞Ïó¥:', cards);
                if (cards.length > 1) {
                    console.log('‚ùå Ïó¨Îü¨ Ïπ¥Îìú ÏÑ†ÌÉùÏùÄ ÎçîÎ∏îÌÅ¥Î¶≠ Î∂àÍ∞Ä');
                    return;
                }
                
                if (!this.canPickUpCard(position)) {
                    console.log('‚ùå Ïπ¥ÎìúÎ•º ÏßëÏùÑ Ïàò ÏóÜÏùå');
                    return;
                }
                console.log('‚úÖ Ïπ¥ÎìúÎ•º ÏßëÏùÑ Ïàò ÏûàÏùå');
                
                // Ïã§Ï†ú Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (DOM ÏöîÏÜå ÎåÄÏã†)
                const cardArray = this.getCardFromPosition(position);
                console.log('Ïπ¥Îìú Î∞∞Ïó¥ (Ïû¨ÌôïÏù∏):', cardArray);
                if (!cardArray || cardArray.length === 0 || !cardArray[0]) {
                    console.log('‚ùå Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏùå');
                    return;
                }
                
                const cardData = cardArray[0];
                console.log('Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞:', cardData);
                
                // ÌòÑÏû¨ Ïπ¥Îìú ÏöîÏÜåÎ•º Ï†ïÌôïÌûà Ï∞æÍ∏∞ (ÎçîÎ∏îÌÉ≠Îêú Ïπ¥Îìú)
                const currentCardElement = this.findFreshCardElement(position);
                console.log('Double click animation - position:', position, 'card element:', currentCardElement);
                if (!currentCardElement) {
                    console.log('Card element not found for animation');
                    return;
                }
                
                // ÌôàÏÖÄÏóê ÎÜìÏùÑ Ïàò ÏûàÎäîÏßÄ Î®ºÏ†Ä ÌôïÏù∏ (Î™®Îì† Ïπ¥ÎìúÏóê ÎåÄÌï¥)
                const homeCellTarget = this.findHomeCellTarget(cardData);
                console.log('ÌôàÏÖÄ ÌÉÄÍ≤ü:', homeCellTarget);
                if (homeCellTarget) {
                    const canDropToHomeCell = this.canDropCard(position, homeCellTarget);
                    console.log('ÌôàÏÖÄÏóê ÎÜìÏùÑ Ïàò ÏûàÏùå:', canDropToHomeCell);
                    if (canDropToHomeCell) {
                        console.log('‚úÖ ÌôàÏÖÄÎ°ú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë');
                        this.animateCardMove(currentCardElement, position, homeCellTarget);
                        return;
                    }
                }
                
                // ÌôàÏÖÄÏóê ÎÜìÏùÑ Ïàò ÏóÜÏúºÎ©¥ ÌîÑÎ¶¨ÏÖÄÎ°ú Ïù¥Îèô
                const freeCellTarget = this.findEmptyFreeCell();
                console.log('ÌîÑÎ¶¨ÏÖÄ ÌÉÄÍ≤ü:', freeCellTarget);
                if (freeCellTarget) {
                    console.log('‚úÖ ÌîÑÎ¶¨ÏÖÄÎ°ú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë');
                    this.animateCardMove(currentCardElement, position, freeCellTarget);
                    return;
                }
                
                console.log('‚ùå Ïú†Ìö®Ìïú Î™©Ìëú ÏúÑÏπòÍ∞Ä ÏóÜÏùå');
                
                e.preventDefault();
            }
            
            animateOriginalCard(cardElement, fromPosition, toPosition, callback) {
                console.log('=== animateOriginalCard ÏãúÏûë ===');
                console.log('Ïπ¥Îìú ÏöîÏÜå:', cardElement);
                console.log('ÏãúÏûë ÏúÑÏπò:', fromPosition);
                console.log('Î™©Ìëú ÏúÑÏπò:', toPosition);
                
                // ÏÜîÎ¶¨ÌÖåÏñ¥Ï≤òÎüº Îã®ÏàúÌïòÍ≤å - Î™©Ìëú ÏÖÄ Ï∞æÍ∏∞
                let targetCell;
                if (toPosition.type === 'freecell') {
                    targetCell = document.querySelector(`.cell[data-type="freecell"][data-index="${toPosition.index}"]`);
                    console.log('ÌîÑÎ¶¨ÏÖÄ ÌÉÄÍ≤ü ÏÖÄ:', targetCell);
                } else if (toPosition.type === 'home') {
                    targetCell = document.querySelector(`.cell[data-type="home"][data-suit="${toPosition.index}"]`);
                    console.log('ÌôàÏÖÄ ÌÉÄÍ≤ü ÏÖÄ:', targetCell);
                }
                
                if (!targetCell) {
                    console.log('‚ùå ÌÉÄÍ≤ü ÏÖÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå, Ï¶âÏãú Ïù¥Îèô');
                    this.moveCard(fromPosition, toPosition);
                    this.render();
                    this.checkAutoComplete();
                    this.checkWin();
                    if (callback) callback();
                    return;
                }
                console.log('‚úÖ ÌÉÄÍ≤ü ÏÖÄ Ï∞æÏùå');
                
                // ÏõêÎ≥∏ Ïπ¥Îìú ÏúÑÏπò Î∞è Î™©Ìëú ÏúÑÏπò Í≥ÑÏÇ∞ (ÏÜîÎ¶¨ÌÖåÏñ¥Ï≤òÎüº)
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë Ï†ÑÏóê Ïπ¥Îìú ÏúÑÏπò Ïû¨ÌôïÏù∏
                const cardRect = cardElement.getBoundingClientRect();
                const targetRect = targetCell.getBoundingClientRect();
                
                // Ïπ¥ÎìúÍ∞Ä Ïã§Ï†úÎ°ú ÏõêÎûò ÏúÑÏπòÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                if (cardRect.left === 0 && cardRect.top === 0) {
                    // Ïπ¥Îìú ÏúÑÏπòÍ∞Ä Ïù¥ÏÉÅÌïòÎ©¥ Ï¶âÏãú Ïù¥Îèô
                    this.moveCard(fromPosition, toPosition);
                    this.render();
                    this.checkAutoComplete();
                    this.checkWin();
                    if (callback) callback();
                    return;
                }
                
                // Ïπ¥ÎìúÍ∞Ä Ïù¥ÎØ∏ fixed ÏÉÅÌÉúÎùºÎ©¥ ÌòÑÏû¨ ÏúÑÏπòÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                if (cardElement.style.position === 'fixed') {
                    // ÌòÑÏû¨ fixed ÏúÑÏπòÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (Ïù¥ÎØ∏ left, topÏù¥ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏùå)
                    cardElement.style.zIndex = '10000';
                    cardElement.style.pointerEvents = 'none';
                    // ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú Î∞îÎ°ú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                    cardElement.style.transform = 'none';
                    cardElement.style.transition = 'none';
                } else {
                    // ÏõêÎ≥∏ Ïπ¥ÎìúÎ•º fixedÎ°ú Ï†ÑÌôòÌïòÏó¨ Ïï†ÎãàÎ©îÏù¥ÏÖò
                    // Í∏∞Ï°¥ Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Ï†úÍ±∞ ÌõÑ ÏÉàÎ°ú ÏÑ§Ï†ï
                    cardElement.style.removeProperty('position');
                    cardElement.style.removeProperty('left');
                    cardElement.style.removeProperty('top');
                    cardElement.style.removeProperty('transform');
                    cardElement.style.removeProperty('transition');
                    
                    cardElement.style.position = 'fixed';
                    cardElement.style.left = cardRect.left + 'px';
                    cardElement.style.top = cardRect.top + 'px';
                    cardElement.style.zIndex = '10000';
                    cardElement.style.pointerEvents = 'none';
                    // Í∞ïÏ†úÎ°ú ÏúÑÏπò Ïû¨ÏÑ§Ï†ï (ÌúòÎäî ÌòÑÏÉÅ Î∞©ÏßÄ)
                    cardElement.style.transform = 'none';
                    cardElement.style.transition = 'none';
                }
                
                // Î™©Ìëú ÏúÑÏπòÍπåÏßÄÏùò Ïù¥Îèô Í±∞Î¶¨ Í≥ÑÏÇ∞ (ÏÜîÎ¶¨ÌÖåÏñ¥Ï≤òÎüº Ï†ïÌôïÌïòÍ≤å)
                const targetCenterX = targetRect.left + (targetRect.width / 2);
                const targetCenterY = targetRect.top + (targetRect.height / 2);
                
                const cardCenterX = cardRect.left + (cardRect.width / 2);
                const cardCenterY = cardRect.top + (cardRect.height / 2);
                
                const deltaX = targetCenterX - cardCenterX;
                const deltaY = targetCenterY - cardCenterY;
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë (ÏûêÎèôÏôÑÏÑ± ÏãúÏóêÎßå Îçî Îπ†Î•¥Í≤å)
                const isAutoComplete = callback && callback.toString().includes('animateCardsSequentially');
                const animationDuration = isAutoComplete ? '1s' : '0.3s';
                const waitTime = isAutoComplete ? 10 : 100; // Î™®Î∞îÏùºÏóêÏÑú Îçî Í∏¥ ÎåÄÍ∏∞ ÏãúÍ∞Ñ
                
                // ÏúÑÏπò ÏïàÏ†ïÌôîÎ•º ÏúÑÌïú ÎåÄÍ∏∞
                console.log('Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë ÎåÄÍ∏∞ Ï§ë...', { waitTime, animationDuration, deltaX, deltaY });
                setTimeout(() => {
                    console.log('üé¨ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë!');
                    cardElement.style.transition = `transform ${animationDuration} cubic-bezier(0.165, 0.84, 0.44, 1)`;
                    cardElement.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.9)`;
                    cardElement.style.opacity = '0.85';
                    console.log('Ïï†ÎãàÎ©îÏù¥ÏÖò CSS Ï†ÅÏö©Îê®:', {
                        transition: cardElement.style.transition,
                        transform: cardElement.style.transform,
                        opacity: cardElement.style.opacity
                    });
                }, waitTime);
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Ï†ïÎ¶¨
                const handleAnimationEnd = () => {
                    console.log('üé¨ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å!');
                    try {
                        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
                        cardElement.removeEventListener('transitionend', handleAnimationEnd);
                        
                        // Ïã§Ï†ú Ïπ¥Îìú Ïù¥Îèô ÏàòÌñâ
                        this.moveCard(fromPosition, toPosition);
                        
                        // ÏõêÎ≥∏ Ïπ¥Îìú Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('opacity');
                        cardElement.style.removeProperty('transition');
                        cardElement.style.removeProperty('pointer-events');
                        
                        // Î†åÎçîÎßÅÏúºÎ°ú ÏÉàÎ°úÏö¥ Ïπ¥Îìú ÌëúÏãú
                        this.render();
                        this.checkAutoComplete();
                        this.checkWin();
                        
                        // ÏΩúÎ∞± Ìï®ÏàòÍ∞Ä ÏûàÏúºÎ©¥ Ìò∏Ï∂ú
                        if (callback && typeof callback === 'function') {
                            callback();
                        }
                    } catch (error) {
                        // Ïò§Î•ò Î∞úÏÉù ÏãúÏóêÎèÑ Î†åÎçîÎßÅÏùÄ ÏàòÌñâ
                        try {
                            this.render();
                            if (callback && typeof callback === 'function') {
                                callback();
                            }
                        } catch (renderError) {
                            // Î†åÎçîÎßÅ Ïò§Î•ò Î¨¥Ïãú
                        }
                    }
                };
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
                cardElement.addEventListener('transitionend', handleAnimationEnd);
                
                // ÏïàÏ†ÑÏû•Ïπò: 300ms ÌõÑÏóêÎèÑ Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ ÎÅùÎÇòÏßÄ ÏïäÏúºÎ©¥ Í∞ïÏ†ú ÏôÑÎ£å
                setTimeout(() => {
                    if (cardElement.style.transition) {
                        handleAnimationEnd();
                    }
                }, 300);
            }
            
            animateCardMove(cardElement, fromPosition, toPosition, callback) {
                console.log('=== animateCardMove Ìò∏Ï∂ú ===');
                console.log('Ïπ¥Îìú ÏöîÏÜå:', cardElement);
                console.log('ÏãúÏûë ÏúÑÏπò:', fromPosition);
                console.log('Î™©Ìëú ÏúÑÏπò:', toPosition);
                
                // ÏÜîÎ¶¨ÌÖåÏñ¥Ï≤òÎüº Îã®ÏàúÌïòÍ≤å - ÏõêÎ≥∏ Ïπ¥ÎìúÎ•º Î∞îÎ°ú Ïù¥Îèô
                this.animateOriginalCard(cardElement, fromPosition, toPosition, callback);
            }
            
            findCardRowInColumn(columnIndex, cardData) {
                const column = this.columns[columnIndex];
                for (let row = 0; row < column.length; row++) {
                    if (this.cardsEqual(column[row], cardData)) {
                        return row;
                    }
                }
                return column.length - 1; // Í∏∞Î≥∏Í∞íÏúºÎ°ú Îß® ÏúÑ
            }
            
            findFreshCardElement(position) {
                try {
                    if (position.type === 'column') {
                        const column = document.querySelector(`[data-column="${position.column}"]`);
                        if (!column) return null;
                        
                        const cardElements = Array.from(column.querySelectorAll('.card'));
                        
                        // position.rowÍ∞Ä ÏßÄÏ†ïÎêòÏñ¥ ÏûàÏúºÎ©¥ Ìï¥Îãπ ÏúÑÏπòÏùò Ïπ¥Îìú Î∞òÌôò
                        if (position.row !== undefined && position.row >= 0 && position.row < cardElements.length) {
                            return cardElements[position.row] || null;
                        }
                        
                        // Í∏∞Î≥∏Ï†ÅÏúºÎ°úÎäî Îß® ÏúÑ Ïπ¥Îìú Î∞òÌôò
                        return cardElements[cardElements.length - 1] || null;
                        
                    } else if (position.type === 'freecell') {
                        const freecell = document.querySelector(`.cell[data-type="freecell"][data-index="${position.index}"]`);
                        if (!freecell) return null;
                        
                        return freecell.querySelector('.card') || null;
                    }
                } catch (error) {
                    // Î¨¥Ïãú
                }
                
                return null;
            }
            
            findEmptyFreeCell() {
                for (let i = 0; i < 4; i++) {
                    if (this.freeCells[i] === null) {
                        return {type: 'freecell', index: i};
                    }
                }
                return null;
            }
            
            findHomeCellTarget(cardData) {
                return {type: 'home', index: cardData.suit};
            }
            
            findCardPosition(cardElement) {
                const cardData = this.getCardData(cardElement);
                
                // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Ï∞æÍ∏∞
                for (let i = 0; i < 4; i++) {
                    if (this.freeCells[i] && this.cardsEqual(this.freeCells[i], cardData)) {
                        return {type: 'freecell', index: i};
                    }
                }
                
                // Ïª¨ÎüºÏóêÏÑú Ï∞æÍ∏∞
                for (let col = 0; col < 8; col++) {
                    for (let row = 0; row < this.columns[col].length; row++) {
                        if (this.cardsEqual(this.columns[col][row], cardData)) {
                            return {type: 'column', column: col, row: row};
                        }
                    }
                }
                
                return null;
            }
            
            findCardPositionByElement(cardElement) {
                // DOM ÏöîÏÜåÏùò Ïã§Ï†ú ÏúÑÏπòÎ•º Í∏∞Î∞òÏúºÎ°ú Ï†ïÌôïÌïú ÏúÑÏπò Ï∞æÍ∏∞
                
                // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Ï∞æÍ∏∞
                const freecellParent = cardElement.closest('.cell[data-type="freecell"]');
                if (freecellParent) {
                    const index = parseInt(freecellParent.dataset.index);
                    return {type: 'freecell', index: index};
                }
                
                // Ïª¨ÎüºÏóêÏÑú Ï∞æÍ∏∞
                const columnParent = cardElement.closest('.column');
                if (columnParent) {
                    const columnIndex = parseInt(columnParent.dataset.column);
                    const allCardsInColumn = Array.from(columnParent.querySelectorAll('.card'));
                    const cardIndex = allCardsInColumn.indexOf(cardElement);
                    
                    if (cardIndex !== -1) {
                        return {type: 'column', column: columnIndex, row: cardIndex};
                    }
                }
                
                // fallback: Í∏∞Ï°¥ Î∞©Ïãù ÏÇ¨Ïö©
                return this.findCardPosition(cardElement);
            }
            
            getCardData(cardElement) {
                const img = cardElement.querySelector('img');
                const src = img.src;
                const filename = src.split('/').pop();
                const [suit, value] = filename.replace('.png', '').split('-');
                return {
                    suit: suit,
                    value: value,
                    color: suit === 'hearts' || suit === 'diamonds' ? 'red' : 'black',
                    number: this.cardValues[value]
                };
            }
            
            cardsEqual(card1, card2) {
                return card1.suit === card2.suit && card1.value === card2.value;
            }
            
            canPickUpCard(position) {
                if (position.type === 'freecell') {
                    return true;
                } else if (position.type === 'column') {
                    // ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÎ∂ÄÌÑ∞ Îß® ÏïÑÎûòÍπåÏßÄÍ∞Ä Ïò¨Î∞îÎ•∏ ÏàúÏÑúÏù∏ÏßÄ ÌôïÏù∏
                    return this.isValidSequence(position.column, position.row);
                }
                return false;
            }
            
            isValidSequence(columnIndex, startRow) {
                const column = this.columns[columnIndex];
                
                for (let i = startRow; i < column.length - 1; i++) {
                    const currentCard = column[i];
                    const nextCard = column[i + 1];
                    
                    // ÏÉâÍπîÏù¥ Î≤àÍ∞àÏïÑÍ∞ÄÍ≥† Ïà´ÏûêÍ∞Ä ÎÇ¥Î¶ºÏ∞®ÏàúÏù¥Ïñ¥Ïïº Ìï®
                    if (currentCard.color === nextCard.color || 
                        currentCard.number !== nextCard.number + 1) {
                        return false;
                    }
                }
                return true;
            }
            
            findDropTarget(x, y) {
                // ÎìúÎûòÍ∑∏ Ï§ëÏù∏ Ïπ¥ÎìúÎì§ÏùÑ ÏûÑÏãúÎ°ú Ïà®Í∏∞Í∏∞
                const draggedElements = this.draggedCardElements || [];
                const originalPointerEvents = [];
                
                draggedElements.forEach((el, index) => {
                    originalPointerEvents[index] = el.style.pointerEvents;
                    el.style.pointerEvents = 'none';
                });
                
                const element = document.elementFromPoint(x, y);
                
                // ÏõêÎûò ÏÉÅÌÉúÎ°ú Î≥µÏõê
                draggedElements.forEach((el, index) => {
                    el.style.pointerEvents = originalPointerEvents[index];
                });
                
                if (!element) return null;
                
                // ÏÖÄ Ï≤¥ÌÅ¨
                const cell = element.closest('.cell');
                if (cell) {
                    const target = {
                        type: cell.dataset.type,
                        index: cell.dataset.index ? parseInt(cell.dataset.index) : cell.dataset.suit
                    };
                    return target;
                }
                
                // Ïª¨Îüº Ï≤¥ÌÅ¨
                const column = element.closest('.column');
                if (column) {
                    const target = {
                        type: 'column',
                        index: parseInt(column.dataset.column)
                    };
                    return target;
                }
                
                return null;
            }
            
            canDropCard(from, to) {
                const cards = this.getCardFromPosition(from);
                if (!cards || cards.length === 0) {
                    return false;
                }
                
                const topCard = cards[0]; // Îß® ÏúÑ Ïπ¥ÎìúÎßå Ï≤¥ÌÅ¨
                
                if (to.type === 'freecell') {
                    // ÌîÑÎ¶¨ÏÖÄÏóêÎäî Ïπ¥Îìú 1Ïû•Îßå ÎÜìÏùÑ Ïàò ÏûàÏùå
                    if (cards.length > 1) {
                        return false;
                    }
                    const canDrop = this.freeCells[to.index] === null;
                    return canDrop;
                } else if (to.type === 'home') {
                    // ÌôàÏÖÄÏóêÎäî Ïπ¥Îìú 1Ïû•Îßå ÎÜìÏùÑ Ïàò ÏûàÏùå
                    if (cards.length > 1) {
                        return false;
                    }
                    const stack = this.homeCells[to.index];
                    if (topCard.suit !== to.index) return false;
                    
                    if (stack.length === 0) {
                        return topCard.value === 'ace';
                    } else {
                        const homeTopCard = stack[stack.length - 1];
                        return topCard.number === homeTopCard.number + 1;
                    }
                                } else if (to.type === 'column') {
                    const column = this.columns[to.index];
                    
                    if (column.length === 0) {
                        return true;
                    }
                    
                    const columnTopCard = column[column.length - 1];
                    const canDrop = topCard.color !== columnTopCard.color && topCard.number === columnTopCard.number - 1;
                    return canDrop;
                }
                
                return false;
            }
            
            getCardFromPosition(position) {
                if (position.type === 'freecell') {
                    const card = this.freeCells[position.index];
                    return card ? [card] : [];
                } else if (position.type === 'column') {
                    // ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÎ∂ÄÌÑ∞ Îß® ÏïÑÎûòÍπåÏßÄ Î™®Îì† Ïπ¥Îìú Î∞òÌôò
                    const column = this.columns[position.column];
                    if (position.row >= 0 && position.row < column.length) {
                        return column.slice(position.row);
                    }
                    return [];
                }
                return [];
            }
            
            getTopCardFromPosition(position) {
                if (position.type === 'freecell') {
                    return this.freeCells[position.index];
                } else if (position.type === 'column') {
                    return this.columns[position.column][position.row];
                }
                return null;
            }
            
            moveCard(from, to) {
                const cards = this.getCardFromPosition(from);
                
                // Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!cards || cards.length === 0 || !cards[0]) {
                    return;
                }
                
                // ÏõêÎûò ÏúÑÏπòÏóêÏÑú Ï†úÍ±∞
                if (from.type === 'freecell') {
                    this.freeCells[from.index] = null;
                } else if (from.type === 'column') {
                    // ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÎ∂ÄÌÑ∞ Îß® ÏïÑÎûòÍπåÏßÄ Î™®Îëê Ï†úÍ±∞
                    this.columns[from.column].splice(from.row, cards.length);
                }
                
                // ÏÉà ÏúÑÏπòÏóê Ï∂îÍ∞Ä
                if (to.type === 'freecell') {
                    this.freeCells[to.index] = cards[0];
                } else if (to.type === 'home') {
                    this.homeCells[to.index].push(cards[0]);
                } else if (to.type === 'column') {
                    // Ïó¨Îü¨ Ïπ¥ÎìúÎ•º ÏàúÏÑúÎåÄÎ°ú Ï∂îÍ∞Ä
                    this.columns[to.index].push(...cards);
                }
            }
            

            
            clearDropTargets() {
                document.querySelectorAll('.drop-target').forEach(el => {
                    el.classList.remove('drop-target');
                });
            }
            
            render() {
                this.renderFreeCells();
                this.renderHomeCells();
                this.renderColumns();
            }
            
            renderFreeCells() {
                for (let i = 0; i < 4; i++) {
                    const cell = document.querySelector(`[data-type="freecell"][data-index="${i}"]`);
                    if (this.freeCells[i]) {
                        cell.innerHTML = '';
                        const cardElement = this.createCardElement(this.freeCells[i]);
                        
                        // createCardElementÍ∞Ä nullÏùÑ Î∞òÌôòÌïú Í≤ΩÏö∞ Ï≤òÎ¶¨
                        if (!cardElement) {
                            cell.innerHTML = '';
                            return;
                        }
                        
                        // ÎìúÎûòÍ∑∏ Í¥ÄÎ†® Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Ï†úÍ±∞
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('pointer-events');
                        cardElement.classList.remove('dragging');
                        
                        // ÌîÑÎ¶¨ÏÖÄ Í∏∞Î≥∏ Ïä§ÌÉÄÏùº Ï†ÅÏö©
                        cardElement.style.position = 'relative';
                        cardElement.style.margin = '0';
                        
                        cell.appendChild(cardElement);
                    } else {
                        cell.innerHTML = '';
                    }
                }
            }
            
            renderHomeCells() {
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                const symbols = {hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†'};
                
                suits.forEach(suit => {
                    const cell = document.querySelector(`[data-type="home"][data-suit="${suit}"]`);
                    const stack = this.homeCells[suit];
                    
                    if (stack.length > 0) {
                        cell.innerHTML = '';
                        const cardElement = this.createCardElement(stack[stack.length - 1]);
                        
                        // createCardElementÍ∞Ä nullÏùÑ Î∞òÌôòÌïú Í≤ΩÏö∞ Ï≤òÎ¶¨
                        if (!cardElement) {
                            cell.innerHTML = symbols[suit];
                            return;
                        }
                        
                        // ÎìúÎûòÍ∑∏ Í¥ÄÎ†® Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Ï†úÍ±∞
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('pointer-events');
                        cardElement.classList.remove('dragging');
                        
                        // ÌôàÏÖÄ Í∏∞Î≥∏ Ïä§ÌÉÄÏùº Ï†ÅÏö©
                        cardElement.style.position = 'relative';
                        cardElement.style.margin = '0';
                        
                        cell.appendChild(cardElement);
                    } else {
                        cell.innerHTML = symbols[suit];
                    }
                });
            }
            
            renderColumns() {
                for (let col = 0; col < 8; col++) {
                    const column = document.querySelector(`[data-column="${col}"]`);
                    column.innerHTML = '';
                    
                    this.columns[col].forEach((card, index) => {
                        const cardElement = this.createCardElement(card);
                        
                        // createCardElementÍ∞Ä nullÏùÑ Î∞òÌôòÌïú Í≤ΩÏö∞ Ï≤òÎ¶¨
                        if (!cardElement) {
                            return;
                        }
                        
                        // ÎìúÎûòÍ∑∏ Í¥ÄÎ†® Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Ï†úÍ±∞ ÌõÑ Ïª¨Îüº Ïä§ÌÉÄÏùº Ï†ÅÏö©
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('pointer-events');
                        cardElement.classList.remove('dragging');
                        
                        // Ïª¨ÎüºÏóêÏÑú Ïò¨Î∞îÎ•∏ ÏúÑÏπò ÏÑ§Ï†ï
                        cardElement.style.position = 'absolute';
                        cardElement.style.left = '50%';
                        cardElement.style.transform = 'translateX(-50%)';
                        cardElement.style.top = `${index * 30}px`;
                        
                        column.appendChild(cardElement);
                    });
                }
            }
            
            createCardElement(card) {
                // Ïπ¥Îìú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Í∞ïÌôî
                if (!card) {
                    return null;
                }
                
                if (!card.suit || !card.value) {
                    return null;
                }
                
                try {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    
                    const img = document.createElement('img');
                    img.src = `../solitaire/cards/${card.suit}-${card.value}.png`;
                    img.alt = `${card.value} of ${card.suit}`;
                    
                    cardDiv.appendChild(img);
                    return cardDiv;
                } catch (error) {
                    return null;
                }
            }
            
            checkAutoComplete() {
                // 4Í∞ú Î¨¥Îä¨ Î™®ÎëêÍ∞Ä ÏôÑÏÑ±ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                if (this.areAllSuitsCompleted()) {
                    this.autoMoveAllCardsToHome();
                }
            }
            
            checkWin() {
                // 4Í∞ú Î¨¥Îä¨ Î™®ÎëêÍ∞Ä ÏôÑÏÑ±ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                if (this.areAllSuitsCompleted()) {
                    this.autoMoveAllCardsToHome();
                }
            }
            
            isGameWon() {
                // Î™®Îì† ÌôàÏÖÄÏù¥ ÏôÑÏÑ±ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                return suits.every(suit => this.homeCells[suit].length === 13);
            }
            
            playWinAnimation() {
                
                // ÌôàÏÖÄÏùò Î™®Îì† Ïπ¥ÎìúÏóê ÏäπÎ¶¨ Ìö®Í≥º Ï†ÅÏö©
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                suits.forEach((suit, suitIndex) => {
                    const homeCell = document.querySelector(`[data-type="home"][data-suit="${suit}"]`);
                    if (homeCell) {
                        const card = homeCell.querySelector('.card');
                        if (card) {
                            // ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÏäπÎ¶¨ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ÅÏö©
                            setTimeout(() => {
                                card.style.transition = 'transform 0.5s ease-out';
                                card.style.transform = 'scale(1.1) rotate(5deg)';
                                
                                setTimeout(() => {
                                    card.style.transform = 'scale(1) rotate(0deg)';
                                }, 500);
                            }, suitIndex * 100);
                        }
                    }
                });
                
                // ÏäπÎ¶¨ Î©îÏãúÏßÄ ÌëúÏãú
                setTimeout(() => {
                    this.showWinMessage();
                }, 1000);
            }
            
            showWinMessage() {
                const winMessage = document.querySelector('.win-message');
                if (winMessage) {
                    winMessage.style.display = 'block';
                    winMessage.innerHTML = `
                        <h2>üéâ Ï∂ïÌïòÌï©ÎãàÎã§! üéâ</h2>
                        <p>ÌîÑÎ¶¨ÏÖÄÏùÑ ÏôÑÏÑ±ÌñàÏäµÎãàÎã§!</p>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button onclick="newGame(); this.parentElement.parentElement.style.display='none';" style="padding: 10px 20px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer;">ÏÉàÎ°úÌïòÍ∏∞</button>
                            <button onclick="window.top.location.href='../../index.html'" style="padding: 10px 20px; border: none; border-radius: 5px; background: #2196F3; color: white; cursor: pointer;">Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        </div>
                    `;
                }
            }
            
            areAllSuitsCompleted() {
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                
                for (let suit of suits) {
                    // Í∞Å Î¨¥Îä¨Î≥ÑÎ°ú A~KÍπåÏßÄ Î™®Îì† Ïπ¥ÎìúÍ∞Ä Í≤åÏûÑÌåêÏóê Ïò¨Î∞îÎ•∏ ÏàúÏÑúÎ°ú ÏûàÎäîÏßÄ ÌôïÏù∏
                    if (!this.isSuitCompleted(suit)) {
                        return false;
                    }
                }
                
                return true;
            }
            
            isSuitCompleted(suit) {
                const homeStack = this.homeCells[suit];
                const allCards = this.getAllCardsOfSuit(suit);
                
                // Ìï¥Îãπ Î¨¥Îä¨Ïùò Ïπ¥ÎìúÍ∞Ä 13Ïû•Ïù¥ ÏïÑÎãàÎ©¥ ÏôÑÏÑ±ÎêòÏßÄ ÏïäÏùå
                if (allCards.length !== 13) return false;
                
                // AÎ∂ÄÌÑ∞ KÍπåÏßÄ ÏàúÏÑúÎåÄÎ°ú ÏûàÎäîÏßÄ ÌôïÏù∏
                for (let i = 0; i < 13; i++) {
                    const expectedNumber = i + 1; // 1(A), 2, 3, ..., 13(K)
                    
                    if (!allCards.find(card => card.number === expectedNumber)) {
                        return false;
                    }
                }
                
                // Î™®Îì† Ïπ¥ÎìúÍ∞Ä Ïò¨Î∞îÎ•∏ ÏàúÏÑúÎ°ú ÏåìÏùº Ïàò ÏûàÎäîÏßÄ ÌôïÏù∏
                return this.canMoveAllCardsToHome(suit);
            }
            
            getAllCardsOfSuit(suit) {
                const cards = [];
                
                // ÌôàÏÖÄÏóêÏÑú Ï∞æÍ∏∞
                cards.push(...this.homeCells[suit]);
                
                // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Ï∞æÍ∏∞
                for (let cell of this.freeCells) {
                    if (cell && cell.suit === suit) {
                        cards.push(cell);
                    }
                }
                
                // Ïª¨ÎüºÏóêÏÑú Ï∞æÍ∏∞
                for (let column of this.columns) {
                    for (let card of column) {
                        if (card.suit === suit) {
                            cards.push(card);
                        }
                    }
                }
                
                return cards;
            }
            
            canMoveAllCardsToHome(suit) {
                const homeStack = this.homeCells[suit];
                const expectedNext = homeStack.length + 1; // ÌôàÏÖÄÏóê Îì§Ïñ¥Í∞ÄÏïº Ìï† Îã§Ïùå Î≤àÌò∏
                
                // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Îã§Ïùå Ïπ¥Îìú Ï∞æÍ∏∞
                for (let i = 0; i < 4; i++) {
                    const cell = this.freeCells[i];
                    if (cell && cell.suit === suit && cell.number === expectedNext) {
                        return true;
                    }
                }
                
                // Ïª¨ÎüºÏóêÏÑú Îã§Ïùå Ïπ¥Îìú Ï∞æÍ∏∞ (Îß® ÏúÑ Ïπ¥ÎìúÎßå)
                for (let column of this.columns) {
                    if (column.length > 0) {
                        const topCard = column[column.length - 1];
                        if (topCard.suit === suit && topCard.number === expectedNext) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            autoMoveAllCardsToHome() {
                // Ïù¥ÎØ∏ ÏûêÎèôÏôÑÏÑ± Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
                if (this.isAutoCompleting) {
                    return;
                }
                
                this.isAutoCompleting = true;
                
                // Î™®Îì† Ïπ¥ÎìúÎ•º ÏàòÏßëÌïòÏó¨ ÏàúÏÑúÎåÄÎ°ú Ïù¥ÎèôÌï† Ïπ¥Îìú Î™©Î°ù ÏÉùÏÑ±
                const cardsToMove = this.collectAllMovableCards();
                
                if (cardsToMove.length === 0) {
                    this.isAutoCompleting = false;
                    return;
                }
                
                // ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïï†ÎãàÎ©îÏù¥ÏÖò Ïù¥Îèô
                this.animateCardsSequentially(cardsToMove, 0);
            }
            
            collectAllMovableCards() {
                const cardsToMove = [];
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                
                // Í∞Å Î¨¥Îä¨Î≥ÑÎ°ú Ïù¥Îèô Í∞ÄÎä•Ìïú Ïπ¥ÎìúÎì§ÏùÑ ÏàòÏßë
                for (let suit of suits) {
                    const homeStack = this.homeCells[suit];
                    const expectedNext = homeStack.length + 1;
                    
                    // ÌôàÏÖÄÏù¥ Ïù¥ÎØ∏ ÏôÑÏÑ±ÎêòÏóàÏúºÎ©¥ Ïä§ÌÇµ
                    if (homeStack.length === 13) continue;
                    
                    let foundCard = false;
                    
                    // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Î®ºÏ†Ä Ï∞æÍ∏∞ (Ïö∞ÏÑ†ÏàúÏúÑ)
                    for (let i = 0; i < 4; i++) {
                        const cell = this.freeCells[i];
                        if (cell && cell.suit === suit && cell.number === expectedNext) {
                            cardsToMove.push({
                                card: cell,
                                from: {type: 'freecell', index: i},
                                to: {type: 'home', index: suit},
                                suit: suit,
                                number: cell.number
                            });
                            foundCard = true;
                            break; // Í∞ôÏùÄ Î¨¥Îä¨Ïùò Í∞ôÏùÄ Ïà´ÏûêÎäî ÌïòÎÇòÎßå Ï∞æÍ∏∞
                        }
                    }
                    
                    // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Î™ª Ï∞æÏïòÏúºÎ©¥ Ïª¨ÎüºÏóêÏÑú Ï∞æÍ∏∞
                    if (!foundCard) {
                        for (let col = 0; col < 8; col++) {
                            const column = this.columns[col];
                            if (column.length > 0) {
                                // Ïª¨ÎüºÏóêÏÑú Ìï¥Îãπ Ïπ¥ÎìúÏùò Ï†ïÌôïÌïú ÏúÑÏπò Ï∞æÍ∏∞
                                for (let row = column.length - 1; row >= 0; row--) {
                                    const card = column[row];
                                    if (card.suit === suit && card.number === expectedNext) {
                                        cardsToMove.push({
                                            card: card,
                                            from: {type: 'column', column: col, row: row},
                                            to: {type: 'home', index: suit},
                                            suit: suit,
                                            number: card.number
                                        });
                                        foundCard = true;
                                        break; // Í∞ôÏùÄ Î¨¥Îä¨Ïùò Í∞ôÏùÄ Ïà´ÏûêÎäî ÌïòÎÇòÎßå Ï∞æÍ∏∞
                                    }
                                }
                                if (foundCard) break; // Ïª¨ÎüºÏóêÏÑú Ï∞æÏïòÏúºÎ©¥ Îã§Ïùå Ïª¨Îüº Í≤ÄÏÉâ Ï§ëÎã®
                            }
                        }
                    }
                }
                
                // Î™®Îì† Ïπ¥ÎìúÎ•º ÌïòÎÇòÏùò Î∞∞Ïó¥Î°ú ÎßåÎì§Ïñ¥ÏÑú Ïó∞ÏÜç Ïù¥Îèô (Î¨¥Îä¨ Íµ¨Î∂Ñ ÏóÜÏù¥)
                const sortedCards = cardsToMove.sort((a, b) => {
                    // Î®ºÏ†Ä Î¨¥Îä¨ ÏàúÏÑú
                    const suitOrder = ['hearts', 'diamonds', 'clubs', 'spades'];
                    const suitA = suitOrder.indexOf(a.suit);
                    const suitB = suitOrder.indexOf(b.suit);
                    
                    if (suitA !== suitB) {
                        return suitA - suitB;
                    }
                    
                    // Í∞ôÏùÄ Î¨¥Îä¨ ÎÇ¥ÏóêÏÑúÎäî Ïà´Ïûê ÏàúÏÑú
                    return a.number - b.number;
                });
                
                return sortedCards;
            }
            
            animateCardsSequentially(cardsToMove, index) {
                if (index >= cardsToMove.length) {
                    this.render();
                    this.isAutoCompleting = false;
                    
                    // ÏûêÎèôÏôÑÏÑ± ÏôÑÎ£å ÌõÑ ÏäπÎ¶¨ Ï≤¥ÌÅ¨
                    if (this.isGameWon()) {
                        this.playWinAnimation();
                    }
                    return;
                }
                
                const cardInfo = cardsToMove[index];
                
                // ÏõêÎ≥∏ Ïπ¥Îìú ÏóòÎ¶¨Î®ºÌä∏ Ï∞æÍ∏∞
                const cardElement = this.findCardElement(cardInfo.card, cardInfo.from);
                
                if (cardElement) {
                    // ÏõêÎ≥∏ Ïπ¥ÎìúÎ•º ÏßÅÏ†ë Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Ïù¥Îèô
                    this.animateOriginalCard(cardElement, cardInfo.from, cardInfo.to, () => {
                        // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Îã§Ïùå Ïπ¥Îìú ÏãúÏûë
                        setTimeout(() => {
                            this.animateCardsSequentially(cardsToMove, index + 1);
                        }, 100);
                    });
                    
                    // Ïπ¥ÎìúÍ∞Ä 10% ÏßÑÌñâÎê† Îïå Îã§Ïùå Ïπ¥Îìú ÏãúÏûë (Í≤πÏ≥êÏÑú Ïù¥Îèô)
                    setTimeout(() => {
                        // Îã§Ïùå Ïπ¥ÎìúÍ∞Ä ÏïÑÏßÅ Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏïòÏùÑ ÎïåÎßå ÏãúÏûë
                        if (index + 1 < cardsToMove.length) {
                            this.animateCardsSequentially(cardsToMove, index + 1);
                        }
                    }, 100);
                } else {
                    // Ïπ¥Îìú ÏóòÎ¶¨Î®ºÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏúºÎ©¥ Ï¶âÏãú Ïù¥Îèô
                    this.moveCard(cardInfo.from, cardInfo.to);
                    this.render();
                    // Îã§Ïùå Ïπ¥ÎìúÎ°ú Ï¶âÏãú Ïù¥Îèô
                    this.animateCardsSequentially(cardsToMove, index + 1);
                }
            }
            
            moveNextCardToHome(suit) {
                const homeStack = this.homeCells[suit];
                const expectedNext = homeStack.length + 1;
                
                // ÌôàÏÖÄÏù¥ Ïù¥ÎØ∏ ÏôÑÏÑ±ÎêòÏóàÏúºÎ©¥ Ïä§ÌÇµ
                if (homeStack.length === 13) return false;
                
                // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú Ï∞æÍ∏∞
                for (let i = 0; i < 4; i++) {
                    const cell = this.freeCells[i];
                    if (cell && cell.suit === suit && cell.number === expectedNext) {
                        this.homeCells[suit].push(cell);
                        this.freeCells[i] = null;
                        return true;
                    }
                }
                
                // Ïª¨ÎüºÏóêÏÑú Ï∞æÍ∏∞ (Îß® ÏúÑ Ïπ¥ÎìúÎßå)
                for (let col = 0; col < 8; col++) {
                    const column = this.columns[col];
                    if (column.length > 0) {
                        const topCard = column[column.length - 1];
                        if (topCard.suit === suit && topCard.number === expectedNext) {
                            this.homeCells[suit].push(column.pop());
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            findCompletedSequence(column) {
                if (column.length < 13) return {sequence: [], startIndex: -1}; // 13Ïû• ÎØ∏ÎßåÏù¥Î©¥ ÏôÑÏ†ÑÌïú ÏãúÌÄÄÏä§ Î∂àÍ∞ÄÎä•
                
                // Í∞Å Î¨¥Îä¨Î≥ÑÎ°ú ÏôÑÏ†ÑÌïú A~K ÏãúÌÄÄÏä§ Ï∞æÍ∏∞
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                
                for (let suit of suits) {
                    const homeStack = this.homeCells[suit];
                    
                    // ÌôàÏÖÄÏù¥ Ïù¥ÎØ∏ ÏôÑÏÑ±ÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïä§ÌÇµ
                    if (homeStack.length === 13) continue;
                    
                    // Ïª¨ÎüºÏóêÏÑú A(1)Î∂ÄÌÑ∞ K(13)ÍπåÏßÄ ÏôÑÏ†ÑÌïú ÏãúÌÄÄÏä§ Ï∞æÍ∏∞
                    for (let startIdx = 0; startIdx <= column.length - 13; startIdx++) {
                        // AÎ∂ÄÌÑ∞ ÏãúÏûëÌïòÎäîÏßÄ ÌôïÏù∏
                        if (column[startIdx].suit === suit && column[startIdx].value === 'ace') {
                            const sequence = [];
                            let isComplete = true;
                            
                            // AÎ∂ÄÌÑ∞ KÍπåÏßÄ 13Ïû•Ïù¥ Ïó∞ÏÜçÏúºÎ°ú ÏûàÎäîÏßÄ ÌôïÏù∏
                            for (let i = 0; i < 13; i++) {
                                const cardIndex = startIdx + i;
                                if (cardIndex >= column.length) {
                                    isComplete = false;
                                    break;
                                }
                                
                                const card = column[cardIndex];
                                const expectedNumber = i + 1; // 1(A), 2, 3, ..., 13(K)
                                
                                if (card.suit === suit && card.number === expectedNumber) {
                                    sequence.push(card);
                                } else {
                                    isComplete = false;
                                    break;
                                }
                            }
                            
                            // ÏôÑÏ†ÑÌïú A~K ÏãúÌÄÄÏä§Í∞Ä Î∞úÍ≤¨ÎêòÎ©¥ Î∞òÌôò
                            if (isComplete && sequence.length === 13) {
                                return {sequence, startIndex: startIdx};
                            }
                        }
                    }
                }
                
                return {sequence: [], startIndex: -1};
            }
            
            moveSequenceToHome(columnIndex, sequence, startIndex) {
                const suit = sequence[0].suit;
                
                // Ïª¨ÎüºÏóêÏÑú Ï†úÍ±∞ (startIndexÎ∂ÄÌÑ∞ sequence.lengthÎßåÌÅº)
                this.columns[columnIndex].splice(startIndex, sequence.length);
                
                // ÌôàÏÖÄÏóê Ï∂îÍ∞Ä
                for (let card of sequence) {
                    this.homeCells[suit].push(card);
                }
            }

            autoMove() {
                // Ïù¥ÎèôÌï† Ïàò ÏûàÎäî Ïπ¥ÎìúÎì§ÏùÑ Ï∞æÏïÑÏÑú ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïù¥Îèô
                const moveableCards = [];
                
                // Ïª¨ÎüºÏóêÏÑú ÌôàÏÖÄÎ°ú Ïù¥Îèô Í∞ÄÎä•Ìïú Ïπ¥ÎìúÎì§ Ï∞æÍ∏∞
                for (let col = 0; col < 8; col++) {
                    if (this.columns[col].length > 0) {
                        const card = this.columns[col][this.columns[col].length - 1];
                        const homeStack = this.homeCells[card.suit];
                        
                        if ((homeStack.length === 0 && card.value === 'ace') ||
                            (homeStack.length > 0 && homeStack[homeStack.length - 1].number + 1 === card.number)) {
                            
                            // Ïπ¥ÎìúÏùò Ï†ïÌôïÌïú ÏúÑÏπò Ï∞æÍ∏∞
                            const cardRow = this.findCardRowInColumn(col, card);
                            moveableCards.push({
                                card: card,
                                fromPosition: {type: 'column', column: col, row: cardRow},
                                toPosition: {type: 'home', index: card.suit},
                                priority: card.value === 'ace' ? 1 : 2 // ÏóêÏù¥Ïä§ Ïö∞ÏÑ†
                            });
                        }
                    }
                }
                
                // ÌîÑÎ¶¨ÏÖÄÏóêÏÑú ÌôàÏÖÄÎ°ú Ïù¥Îèô Í∞ÄÎä•Ìïú Ïπ¥ÎìúÎì§ Ï∞æÍ∏∞
                for (let i = 0; i < 4; i++) {
                    if (this.freeCells[i]) {
                        const card = this.freeCells[i];
                        const homeStack = this.homeCells[card.suit];
                        
                        if ((homeStack.length === 0 && card.value === 'ace') ||
                            (homeStack.length > 0 && homeStack[homeStack.length - 1].number + 1 === card.number)) {
                            
                            moveableCards.push({
                                card: card,
                                fromPosition: {type: 'freecell', index: i},
                                toPosition: {type: 'home', index: card.suit},
                                priority: card.value === 'ace' ? 1 : 2 // ÏóêÏù¥Ïä§ Ïö∞ÏÑ†
                            });
                        }
                    }
                }
                
                // Ïö∞ÏÑ†ÏàúÏúÑÏóê Îî∞Îùº Ï†ïÎ†¨ (ÏóêÏù¥Ïä§ Î®ºÏ†Ä, Í∑∏ Îã§Ïùå Ïà´Ïûê Ïàú)
                moveableCards.sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    return a.card.number - b.card.number;
                });
                
                // ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïù¥Îèô
                if (moveableCards.length > 0) {
                    this.moveCardsSequentially(moveableCards, 0);
                }
            }
            
            moveCardsSequentially(moveableCards, index) {
                if (index >= moveableCards.length) return;
                
                const moveData = moveableCards[index];
                const cardElement = this.findCardElement(moveData.card, moveData.fromPosition);
                
                if (cardElement) {
                    this.animateCardMove(cardElement, moveData.fromPosition, moveData.toPosition, () => {
                        // Îã§Ïùå Ïπ¥Îìú Ïù¥Îèô (300ms ÌõÑ)
                        setTimeout(() => {
                            this.moveCardsSequentially(moveableCards, index + 1);
                        }, 300);
                    });
                } else {
                    // Ïï†ÎãàÎ©îÏù¥ÏÖò Ïã§Ìå®Ïãú Ï¶âÏãú Ïù¥ÎèôÌïòÍ≥† Îã§ÏùåÏúºÎ°ú
                    this.moveCard(moveData.fromPosition, moveData.toPosition);
                    this.render();
                    setTimeout(() => {
                        this.moveCardsSequentially(moveableCards, index + 1);
                    }, 100);
                }
            }
            
            findCardElement(cardData, position) {
                try {
                    if (position.type === 'column') {
                        const column = document.querySelector(`[data-column="${position.column}"]`);
                        if (!column) return null;
                        
                        const cardElements = Array.from(column.querySelectorAll('.card'));
                        
                        // Ï†ïÌôïÌïú row ÏúÑÏπòÏùò Ïπ¥Îìú Ï∞æÍ∏∞ (ÏûêÎèôÏôÑÏÑ±ÏóêÏÑúÎäî Ìï≠ÏÉÅ Îß® ÏúÑ Ïπ¥Îìú)
                        if (position.row !== undefined && position.row >= 0 && position.row < cardElements.length) {
                            const targetCardElement = cardElements[position.row];
                            if (targetCardElement) {
                                const elementCardData = this.getCardData(targetCardElement);
                                if (this.cardsEqual(elementCardData, cardData)) {
                                    return targetCardElement;
                                }
                            }
                        }
                        
                        // fallback: Îß® ÏúÑ Ïπ¥ÎìúÏóêÏÑú Ï∞æÍ∏∞
                        const lastCardElement = cardElements[cardElements.length - 1];
                        if (lastCardElement) {
                            const elementCardData = this.getCardData(lastCardElement);
                            if (this.cardsEqual(elementCardData, cardData)) {
                                return lastCardElement;
                            }
                        }
                    } else if (position.type === 'freecell') {
                        const freecell = document.querySelector(`.cell[data-type="freecell"][data-index="${position.index}"]`);
                        if (!freecell) return null;
                        
                        const cardElement = freecell.querySelector('.card');
                        if (cardElement) {
                            const elementCardData = this.getCardData(cardElement);
                            if (this.cardsEqual(elementCardData, cardData)) {
                                return cardElement;
                            }
                        }
                    }
                } catch (error) {
                    // Î¨¥Ïãú
                }
                
                return null;
            }
            
            isCardAtPosition(cardData, position) {
                try {
                    if (position.type === 'column') {
                        const column = this.columns[position.column];
                        if (position.row >= 0 && position.row < column.length) {
                            return this.cardsEqual(column[position.row], cardData);
                        }
                        return false;
                    } else if (position.type === 'freecell') {
                        const cellCard = this.freeCells[position.index];
                        return cellCard && this.cardsEqual(cellCard, cardData);
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            }
            
            checkWin() {
                // ÏäπÎ¶¨ Ï≤¥ÌÅ¨Îäî isGameWon()ÏóêÏÑú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî Ï†úÍ±∞
            }
            
            newGame() {
                this.freeCells = [null, null, null, null];
                this.homeCells = {hearts: [], diamonds: [], clubs: [], spades: []};
                this.columns = [[], [], [], [], [], [], [], []];
                this.draggedCard = null;
                this.draggedFrom = null;
                document.getElementById('winMessage').style.display = 'none';
                this.init();
            }
        }
        
        // Í≤åÏûÑ ÏãúÏûë
        const game = new FreeCell();
        
        // Ï†ÑÏó≠ Ìï®ÏàòÎì§
        function newGame() {
            game.newGame();
        }
        
        function autoMove() {
            game.autoMove();
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        let resizeTimeout;
        let currentBreakpoint = getCurrentBreakpoint();
        
        function getCurrentBreakpoint() {
            if (window.innerWidth > 1200) return 'large';
            if (window.innerWidth > 900) return 'medium';
            if (window.innerWidth > 768) return 'small';
            if (window.innerWidth > 600) return 'xsmall';
            return 'xxsmall';
        }
        
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const newBreakpoint = getCurrentBreakpoint();
                if (newBreakpoint !== currentBreakpoint) {
                    currentBreakpoint = newBreakpoint;
                    game.render();
                }
            }, 100);
        });
    </script>
</body>
</html>