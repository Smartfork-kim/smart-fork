<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¦¬ì…€ - ì›¹ê²Œì„ ëª¨ìŒ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #0F4C75 0%, #3282B8 100%);
            min-height: 100vh;
            color: white;
            user-select: none;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .game-title {
            font-size: 2.5rem;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .game-board {
            max-width: 1246px;
            margin: 50px auto 0 auto;
            box-sizing: border-box;
        }
        
        .top-area {
            display: flex;
            margin-bottom: 45px;
            width: 1246px;
            height: 195px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            box-sizing: border-box;
        }
        
        .free-cells, .home-cells {
            display: flex;
            gap: 12px;
        }
        
        .free-cells {
            position: absolute;
            left: 0;
            top: 0;
        }
        
        .home-cells {
            position: absolute;
            right: 0;
            top: 0;
        }
        
        .cell {
            width: 140px;
            height: 195px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.5);
            padding: 2px; /* ì¹´ë“œì™€ ì…€ ê²½ê³„ ì‚¬ì´ ìµœì†Œ ì—¬ë°± */
            box-sizing: border-box;
        }
        
        .cell.drop-target {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.3);
        }
        
        .play-area {
            display: flex;
            gap: 18px;
            width: 1246px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .column {
            min-height: 600px;
            width: 140px;
            position: relative;
            padding: 3px 0 8px 0; /* ì¢Œìš° íŒ¨ë”© ì œê±°ë¡œ ì •í™•í•œ ì •ë ¬ */
            box-sizing: border-box;
        }
        

        
        .card {
            width: 131px;
            height: 182px;
            border-radius: 12px;
            cursor: grab;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }
        
        .column .card {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .cell .card {
            position: relative;
            margin: 0;
            width: 131px; /* ì…€ í¬ê¸°(140px)ì—ì„œ ì—¬ë°± 9px ì œì™¸, ì‹¤ì œ ì¹´ë“œ ë¹„ìœ¨ 358:500 ì ìš© */
            height: 187px; /* ì…€ í¬ê¸°(195px)ì—ì„œ ì—¬ë°± 8px ì œì™¸ */
        }
        
        .card:active {
            cursor: grabbing;
        }
        
        .card.dragging {
            position: fixed !important;
            transform: scale(1.05) !important;
            opacity: 0.9 !important;
            pointer-events: none !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6) !important;
            z-index: 9999 !important;
            transition: none !important;
        }
        
        .card img {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .win-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 24px;
            display: none;
            z-index: 2000;
        }
        

        
        @media (max-width: 768px) {
            .game-board {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        <h1 class="game-title">
            <span style="color: #e74c3c; font-size: 2.5rem; margin-right: 15px;">â™¥â™¦</span>
            <span style="font-size: 2.5rem;">í”„ë¦¬ì…€</span>
            <span style="color: #2c3e50; font-size: 2.5rem; margin-left: 15px;">â™£â™ </span>
        </h1>
        <div class="controls">
            <button class="btn" onclick="newGame()">ìƒˆ ê²Œì„</button>
            <button class="btn" onclick="autoMove()">ìë™ ì´ë™</button>
        </div>
    </div>
    

    
    <div class="game-board">
        <div class="top-area">
            <div class="free-cells">
                <div class="cell" data-type="freecell" data-index="0"></div>
                <div class="cell" data-type="freecell" data-index="1"></div>
                <div class="cell" data-type="freecell" data-index="2"></div>
                <div class="cell" data-type="freecell" data-index="3"></div>
            </div>
            <div class="home-cells">
                <div class="cell" data-type="home" data-suit="hearts"></div>
                <div class="cell" data-type="home" data-suit="diamonds"></div>
                <div class="cell" data-type="home" data-suit="clubs"></div>
                <div class="cell" data-type="home" data-suit="spades"></div>
            </div>
        </div>
        
        <div class="play-area">
            <div class="column" data-column="0"></div>
            <div class="column" data-column="1"></div>
            <div class="column" data-column="2"></div>
            <div class="column" data-column="3"></div>
            <div class="column" data-column="4"></div>
            <div class="column" data-column="5"></div>
            <div class="column" data-column="6"></div>
            <div class="column" data-column="7"></div>
        </div>
    </div>
    
    <div class="win-message" id="winMessage">
        <div>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</div>
        <div>í”„ë¦¬ì…€ì„ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!</div>
        <button class="btn" onclick="newGame()" style="margin-top: 20px;">ìƒˆ ê²Œì„ ì‹œì‘</button>
    </div>

    <script>
        class FreeCell {
                        constructor() {
                this.freeCells = [null, null, null, null];
                this.homeCells = {hearts: [], diamonds: [], clubs: [], spades: []};
                this.columns = [[], [], [], [], [], [], [], []];
                this.isDragging = false;
                this.dragPrepared = false;
                this.draggedCard = null;
                this.draggedCardElements = [];
                this.draggedCardsData = [];
                this.draggedFrom = null;
                this.dragOffsetX = 0;
                this.dragOffsetY = 0;
                this.isAutoCompleting = false;
                this.cardValues = {
                    'ace': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
                    'jack': 11, 'queen': 12, 'king': 13
                };
                this.init();
            }
            
            init() {
                this.createAndDealCards();
                this.render();
                this.setupEventListeners();
            }
            
            createAndDealCards() {
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                const values = ['ace', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'jack', 'queen', 'king'];
                const cards = [];
                
                // ì¹´ë“œ ìƒì„±
                for (let suit of suits) {
                    for (let value of values) {
                        cards.push({
                            suit: suit,
                            value: value,
                            color: suit === 'hearts' || suit === 'diamonds' ? 'red' : 'black',
                            number: this.cardValues[value]
                        });
                    }
                }
                
                // ì¹´ë“œ ì„ê¸°
                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }
                
                // ì¹´ë“œ ë°°ì¹˜
                let cardIndex = 0;
                for (let col = 0; col < 8; col++) {
                    const cardsInColumn = col < 4 ? 7 : 6;
                    for (let row = 0; row < cardsInColumn; row++) {
                        this.columns[col].push(cards[cardIndex]);
                        cardIndex++;
                    }
                }
            }
            
            setupEventListeners() {
                // ê¸°ë³¸ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë¡œ ë‹¨ìˆœí™”
                document.addEventListener('mousedown', this.handleMouseDown.bind(this));
                document.addEventListener('mousemove', this.handleMouseMove.bind(this));
                document.addEventListener('mouseup', this.handleMouseUp.bind(this));
                document.addEventListener('dblclick', this.handleDoubleClickEvent.bind(this));
            }
            

            
            handleMouseDown(e) {
                const card = e.target.closest('.card');
                if (!card) return;
                
                const position = this.findCardPosition(card);
                if (!position) return;
                
                if (!this.canPickUpCard(position)) return;
                
                // í´ë¦­í•œ ì¹´ë“œì˜ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                const cardRect = card.getBoundingClientRect();
                
                // ë§ˆìš°ìŠ¤ í´ë¦­ ìœ„ì¹˜ì™€ ì¹´ë“œ ì¢Œìƒë‹¨ì˜ ì˜¤í”„ì…‹ ê³„ì‚° (ë‹¨ìˆœí™”)
                this.dragOffsetX = e.clientX - cardRect.left;
                this.dragOffsetY = e.clientY - cardRect.top;
                
                // ë“œë˜ê·¸ ì¤€ë¹„ë§Œ í•˜ê³  ì‹¤ì œ ì‹œì‘ì€ mousemoveì—ì„œ (ë”ë¸”í´ë¦­ì„ ìœ„í•´)
                this.dragPrepared = true;
                this.draggedCard = card;
                this.draggedFrom = position;
                this.draggedCardsData = this.getCardFromPosition(position);
                

                
                e.preventDefault();
            }
            
            startDragging() {
                const position = this.draggedFrom;
                const card = this.draggedCard;
                
                // ì—¬ëŸ¬ ì¹´ë“œë¥¼ ë“œë˜ê·¸í•  ê²½ìš° DOM ìš”ì†Œë“¤ ì°¾ê¸°
                this.draggedCardElements = [];
                
                if (position.type === 'column') {
                    // ì»¬ëŸ¼ì—ì„œ ì—¬ëŸ¬ ì¥ ì„ íƒëœ ê²½ìš°
                    const column = document.querySelector(`[data-column="${position.column}"]`);
                    const allCardElements = Array.from(column.querySelectorAll('.card'));
                    
                    // ì„ íƒëœ ì¹´ë“œë“¤ì˜ ì‹œì‘ ì¸ë±ìŠ¤
                    const startIndex = this.columns[position.column].length - this.draggedCardsData.length;
                    
                    // ì„ íƒëœ ì¹´ë“œë“¤ì˜ DOM ìš”ì†Œë“¤ ìˆ˜ì§‘
                    for (let i = 0; i < this.draggedCardsData.length; i++) {
                        const cardElement = allCardElements[startIndex + i];
                        if (cardElement) {
                            this.draggedCardElements.push(cardElement);
                            
                            // í˜„ì¬ ìœ„ì¹˜ë¥¼ ì •í™•íˆ ê³„ì‚°í•˜ì—¬ fixedë¡œ ì „í™˜
                            const rect = cardElement.getBoundingClientRect();
                            
                            // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì™„ì „ ì œê±° í›„ ì •í™•í•œ ìœ„ì¹˜ ì„¤ì •
                            cardElement.style.removeProperty('left');
                            cardElement.style.removeProperty('transform');
                            cardElement.style.position = 'fixed';
                            cardElement.style.left = rect.left + 'px';
                            cardElement.style.top = rect.top + 'px';
                            cardElement.style.transform = 'scale(1.05)';
                            cardElement.style.zIndex = (9999 + i).toString();
                            cardElement.classList.add('dragging');
                        }
                    }
                } else {
                    // í”„ë¦¬ì…€ì´ë‚˜ í™ˆì…€ì˜ ê²½ìš° ë‹¨ì¼ ì¹´ë“œ
                    this.draggedCardElements.push(card);
                    
                    // í˜„ì¬ ìœ„ì¹˜ë¥¼ ì •í™•íˆ ê³„ì‚°í•˜ì—¬ fixedë¡œ ì „í™˜
                    const rect = card.getBoundingClientRect();
                    
                    // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì™„ì „ ì œê±° í›„ ì •í™•í•œ ìœ„ì¹˜ ì„¤ì •
                    card.style.removeProperty('left');
                    card.style.removeProperty('transform');
                    card.style.position = 'fixed';
                    card.style.left = rect.left + 'px';
                    card.style.top = rect.top + 'px';
                    card.style.transform = 'scale(1.1)';
                    card.style.zIndex = '9999';
                    card.classList.add('dragging');
                }
                
            }
            
            handleMouseMove(e) {
                // ë“œë˜ê·¸ ì¤€ë¹„ ìƒíƒœì—ì„œ ì‹¤ì œ ë“œë˜ê·¸ ì‹œì‘
                if (this.dragPrepared && !this.isDragging) {
                    this.isDragging = true;
                    this.dragPrepared = false;
                    this.startDragging();
                }
                
                if (!this.isDragging || !this.draggedCard) return;
                
                // ì˜¤í”„ì…‹ì„ ê³ ë ¤í•œ ì¹´ë“œ ìœ„ì¹˜ ê³„ì‚° (ë‹¨ìˆœí™”)
                const baseX = e.clientX - this.dragOffsetX;
                const baseY = e.clientY - this.dragOffsetY;
                
                // ëª¨ë“  ì„ íƒëœ ì¹´ë“œë“¤ì„ í•¨ê»˜ ì´ë™ (ì›ë˜ ê°„ê²© ìœ ì§€)
                this.draggedCardElements.forEach((cardElement, index) => {
                    cardElement.style.position = 'fixed';
                    cardElement.style.left = baseX + 'px';
                    cardElement.style.top = (baseY + index * 30) + 'px'; // ì›ë˜ ì»¬ëŸ¼ ê°„ê²©(30px) ìœ ì§€
                    cardElement.style.transform = 'scale(1.05)';
                    cardElement.style.pointerEvents = 'none';
                });
                
                e.preventDefault();
            }
            
            handleMouseUp(e) {
                // ë“œë˜ê·¸ ì¤€ë¹„ë§Œ í•˜ê³  ì‹¤ì œ ë“œë˜ê·¸í•˜ì§€ ì•Šì€ ê²½ìš° (í´ë¦­ ë˜ëŠ” ë”ë¸”í´ë¦­)
                if (this.dragPrepared && !this.isDragging) {
                    this.dragPrepared = false;
                    this.draggedCard = null;
                    this.draggedFrom = null;
                    this.draggedCardsData = [];
                    return;
                }
                
                if (!this.isDragging || !this.draggedCard) return;
                
                const target = this.findDropTarget(e.clientX, e.clientY);
                
                if (target && this.canDropCard(this.draggedFrom, target)) {
                    this.moveCard(this.draggedFrom, target);
                }
                
                // ëª¨ë“  ë“œë˜ê·¸ëœ ì¹´ë“œë“¤ì˜ ìŠ¤íƒ€ì¼ ì™„ì „ ì´ˆê¸°í™”
                this.draggedCardElements.forEach(cardElement => {
                    cardElement.style.removeProperty('position');
                    cardElement.style.removeProperty('left');
                    cardElement.style.removeProperty('top');
                    cardElement.style.removeProperty('transform');
                    cardElement.style.removeProperty('z-index');
                    cardElement.style.removeProperty('pointer-events');
                    cardElement.classList.remove('dragging');
                });
                
                // ë“œë˜ê·¸ ìƒíƒœ ì´ˆê¸°í™”
                this.isDragging = false;
                this.dragPrepared = false;
                this.draggedCard = null;
                this.draggedCardElements = [];
                this.draggedCardsData = [];
                this.draggedFrom = null;
                this.dragOffsetX = 0;
                this.dragOffsetY = 0;
                
                // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                this.render();
                this.checkAutoComplete();
                this.checkWin();
                
                e.preventDefault();
            }

            handleDoubleClickEvent(e) {
                const card = e.target.closest('.card');
                if (!card) return;
                
                // í´ë¦­í•œ ì •í™•í•œ ìœ„ì¹˜ì—ì„œ ì¹´ë“œ ì°¾ê¸°
                const clickX = e.clientX;
                const clickY = e.clientY;
                
                // ì»¬ëŸ¼ì—ì„œ í´ë¦­í•œ ì¹´ë“œ ì°¾ê¸° (ìš°ì„ ìˆœìœ„)
                const columns = document.querySelectorAll('.column');
                let clickedCard = null;
                let clickedPosition = null;
                
                for (let column of columns) {
                    const cards = Array.from(column.querySelectorAll('.card'));
                    for (let i = cards.length - 1; i >= 0; i--) {
                        const cardElement = cards[i];
                        const rect = cardElement.getBoundingClientRect();
                        if (clickX >= rect.left && clickX <= rect.right && 
                            clickY >= rect.top && clickY <= rect.bottom) {
                            clickedCard = cardElement;
                            const columnIndex = parseInt(column.dataset.column);
                            clickedPosition = {type: 'column', column: columnIndex, row: i};
                            break;
                        }
                    }
                    if (clickedCard) break;
                }
                
                // ì»¬ëŸ¼ì—ì„œ ëª» ì°¾ì•˜ìœ¼ë©´ í”„ë¦¬ì…€ì—ì„œ ì°¾ê¸°
                if (!clickedCard) {
                    const freecells = document.querySelectorAll('.cell[data-type="freecell"]');
                    for (let cell of freecells) {
                        const cardElement = cell.querySelector('.card');
                        if (cardElement) {
                            const rect = cardElement.getBoundingClientRect();
                            if (clickX >= rect.left && clickX <= rect.right && 
                                clickY >= rect.top && clickY <= rect.bottom) {
                                clickedCard = cardElement;
                                const index = parseInt(cell.dataset.index);
                                clickedPosition = {type: 'freecell', index: index};
                                break;
                            }
                        }
                    }
                }
                
                if (clickedCard && clickedPosition) {
                    this.handleDoubleClick(e, clickedCard, clickedPosition);
                }
                
                e.preventDefault();
                e.stopPropagation();
            }
            
            handleDoubleClick(e, card, position) {
                // ë“œë˜ê·¸ ì¤€ë¹„/ì§„í–‰ ìƒíƒœ ì™„ì „ ì´ˆê¸°í™” (ë”ë¸”í´ë¦­ê³¼ ë“œë˜ê·¸ ì¶©ëŒ ë°©ì§€)
                this.dragPrepared = false;
                this.isDragging = false;
                
                if (this.draggedCard) {
                    if (this.draggedCardElements.length > 0) {
                        this.draggedCardElements.forEach(cardElement => {
                            cardElement.classList.remove('dragging');
                            cardElement.style.removeProperty('position');
                            cardElement.style.removeProperty('left');
                            cardElement.style.removeProperty('top');
                            cardElement.style.removeProperty('transform');
                            cardElement.style.removeProperty('z-index');
                            cardElement.style.removeProperty('pointer-events');
                        });
                    } else {
                        this.draggedCard.classList.remove('dragging');
                        this.draggedCard.style.removeProperty('position');
                        this.draggedCard.style.removeProperty('left');
                        this.draggedCard.style.removeProperty('top');
                        this.draggedCard.style.removeProperty('transform');
                        this.draggedCard.style.removeProperty('z-index');
                        this.draggedCard.style.removeProperty('pointer-events');
                    }
                    this.clearDropTargets();
                    this.draggedCard = null;
                    this.draggedCardElements = [];
                    this.draggedCardsData = [];
                    this.draggedFrom = null;
                }
                
                if (!position) return;
                
                // ì—¬ëŸ¬ ì¹´ë“œ ì„ íƒì€ ë”ë¸”í´ë¦­ìœ¼ë¡œ ì´ë™ ë¶ˆê°€
                const cards = this.getCardFromPosition(position);
                if (cards.length > 1) return;
                
                if (!this.canPickUpCard(position)) return;
                
                // ì‹¤ì œ ì¹´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (DOM ìš”ì†Œ ëŒ€ì‹ )
                const cardArray = this.getCardFromPosition(position);
                if (!cardArray || cardArray.length === 0 || !cardArray[0]) return;
                
                const cardData = cardArray[0];
                
                // í™ˆì…€ì— ë†“ì„ ìˆ˜ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸ (ëª¨ë“  ì¹´ë“œì— ëŒ€í•´)
                const homeCellTarget = this.findHomeCellTarget(cardData);
                if (homeCellTarget) {
                    const canDropToHomeCell = this.canDropCard(position, homeCellTarget);
                    if (canDropToHomeCell) {
                        this.animateCardMove(card, position, homeCellTarget);
                        return;
                    }
                }
                
                // í™ˆì…€ì— ë†“ì„ ìˆ˜ ì—†ìœ¼ë©´ í”„ë¦¬ì…€ë¡œ ì´ë™
                const freeCellTarget = this.findEmptyFreeCell();
                if (freeCellTarget) {
                    this.animateCardMove(card, position, freeCellTarget);
                    return;
                }
                
                e.preventDefault();
            }
            
            animateOriginalCard(cardElement, fromPosition, toPosition, callback) {
                // ì†”ë¦¬í…Œì–´ì²˜ëŸ¼ ë‹¨ìˆœí•˜ê²Œ - ëª©í‘œ ì…€ ì°¾ê¸°
                let targetCell;
                if (toPosition.type === 'freecell') {
                    targetCell = document.querySelector(`.cell[data-type="freecell"][data-index="${toPosition.index}"]`);
                } else if (toPosition.type === 'home') {
                    targetCell = document.querySelector(`.cell[data-type="home"][data-suit="${toPosition.index}"]`);
                }
                
                if (!targetCell) {
                    this.moveCard(fromPosition, toPosition);
                    this.render();
                    this.checkAutoComplete();
                    this.checkWin();
                    if (callback) callback();
                    return;
                }
                
                // ì›ë³¸ ì¹´ë“œ ìœ„ì¹˜ ë° ëª©í‘œ ìœ„ì¹˜ ê³„ì‚° (ì†”ë¦¬í…Œì–´ì²˜ëŸ¼)
                // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì „ì— ì¹´ë“œ ìœ„ì¹˜ ì¬í™•ì¸
                const cardRect = cardElement.getBoundingClientRect();
                const targetRect = targetCell.getBoundingClientRect();
                
                // ì¹´ë“œê°€ ì‹¤ì œë¡œ ì›ë˜ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸
                if (cardRect.left === 0 && cardRect.top === 0) {
                    // ì¹´ë“œ ìœ„ì¹˜ê°€ ì´ìƒí•˜ë©´ ì¦‰ì‹œ ì´ë™
                    this.moveCard(fromPosition, toPosition);
                    this.render();
                    this.checkAutoComplete();
                    this.checkWin();
                    if (callback) callback();
                    return;
                }
                
                // ì›ë³¸ ì¹´ë“œë¥¼ fixedë¡œ ì „í™˜í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜
                cardElement.style.position = 'fixed';
                cardElement.style.left = cardRect.left + 'px';
                cardElement.style.top = cardRect.top + 'px';
                cardElement.style.zIndex = '10000';
                cardElement.style.pointerEvents = 'none';
                
                // ê°•ì œë¡œ ìœ„ì¹˜ ì¬ì„¤ì • (íœ˜ëŠ” í˜„ìƒ ë°©ì§€)
                cardElement.style.transform = 'none';
                cardElement.style.transition = 'none';
                
                // ëª©í‘œ ìœ„ì¹˜ê¹Œì§€ì˜ ì´ë™ ê±°ë¦¬ ê³„ì‚° (ì†”ë¦¬í…Œì–´ì²˜ëŸ¼ ì •í™•í•˜ê²Œ)
                const targetCenterX = targetRect.left + (targetRect.width / 2);
                const targetCenterY = targetRect.top + (targetRect.height / 2);
                
                const cardCenterX = cardRect.left + (cardRect.width / 2);
                const cardCenterY = cardRect.top + (cardRect.height / 2);
                
                const deltaX = targetCenterX - cardCenterX;
                const deltaY = targetCenterY - cardCenterY;
                
                // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ìë™ì™„ì„± ì‹œì—ë§Œ ë” ë¹ ë¥´ê²Œ)
                const isAutoComplete = callback && callback.toString().includes('animateCardsSequentially');
                const animationDuration = isAutoComplete ? '1s' : '0.3s';
                const waitTime = isAutoComplete ? 10 : 50;
                
                // ìœ„ì¹˜ ì•ˆì •í™”ë¥¼ ìœ„í•œ ëŒ€ê¸°
                setTimeout(() => {
                    cardElement.style.transition = `transform ${animationDuration} cubic-bezier(0.165, 0.84, 0.44, 1)`;
                    cardElement.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.9)`;
                    cardElement.style.opacity = '0.85';
                }, waitTime);
                
                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì •ë¦¬
                const handleAnimationEnd = () => {
                    try {
                        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                        cardElement.removeEventListener('transitionend', handleAnimationEnd);
                        
                        // ì‹¤ì œ ì¹´ë“œ ì´ë™ ìˆ˜í–‰
                        this.moveCard(fromPosition, toPosition);
                        
                        // ì›ë³¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('opacity');
                        cardElement.style.removeProperty('transition');
                        cardElement.style.removeProperty('pointer-events');
                        
                        // ë Œë”ë§ìœ¼ë¡œ ìƒˆë¡œìš´ ì¹´ë“œ í‘œì‹œ
                        this.render();
                        this.checkAutoComplete();
                        this.checkWin();
                        
                        // ì½œë°± í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ
                        if (callback && typeof callback === 'function') {
                            callback();
                        }
                    } catch (error) {
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë Œë”ë§ì€ ìˆ˜í–‰
                        try {
                            this.render();
                            if (callback && typeof callback === 'function') {
                                callback();
                            }
                        } catch (renderError) {
                            // ë Œë”ë§ ì˜¤ë¥˜ ë¬´ì‹œ
                        }
                    }
                };
                
                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                cardElement.addEventListener('transitionend', handleAnimationEnd);
                
                // ì•ˆì „ì¥ì¹˜: 300ms í›„ì—ë„ ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ì§€ ì•Šìœ¼ë©´ ê°•ì œ ì™„ë£Œ
                setTimeout(() => {
                    if (cardElement.style.transition) {
                        handleAnimationEnd();
                    }
                }, 300);
            }
            
            animateCardMove(cardElement, fromPosition, toPosition, callback) {
                // ì†”ë¦¬í…Œì–´ì²˜ëŸ¼ ë‹¨ìˆœí•˜ê²Œ - ì›ë³¸ ì¹´ë“œë¥¼ ë°”ë¡œ ì´ë™
                this.animateOriginalCard(cardElement, fromPosition, toPosition, callback);
            }
            
            findCardRowInColumn(columnIndex, cardData) {
                const column = this.columns[columnIndex];
                for (let row = 0; row < column.length; row++) {
                    if (this.cardsEqual(column[row], cardData)) {
                        return row;
                    }
                }
                return column.length - 1; // ê¸°ë³¸ê°’ìœ¼ë¡œ ë§¨ ìœ„
            }
            
            findFreshCardElement(position) {
                try {
                    if (position.type === 'column') {
                        const column = document.querySelector(`[data-column="${position.column}"]`);
                        if (!column) return null;
                        
                        const cardElements = Array.from(column.querySelectorAll('.card'));
                        
                        // position.rowê°€ ì§€ì •ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ ìœ„ì¹˜ì˜ ì¹´ë“œ ë°˜í™˜
                        if (position.row !== undefined && position.row >= 0 && position.row < cardElements.length) {
                            return cardElements[position.row] || null;
                        }
                        
                        // ê¸°ë³¸ì ìœ¼ë¡œëŠ” ë§¨ ìœ„ ì¹´ë“œ ë°˜í™˜
                        return cardElements[cardElements.length - 1] || null;
                        
                    } else if (position.type === 'freecell') {
                        const freecell = document.querySelector(`.cell[data-type="freecell"][data-index="${position.index}"]`);
                        if (!freecell) return null;
                        
                        return freecell.querySelector('.card') || null;
                    }
                } catch (error) {
                    // ë¬´ì‹œ
                }
                
                return null;
            }
            
            findEmptyFreeCell() {
                for (let i = 0; i < 4; i++) {
                    if (this.freeCells[i] === null) {
                        return {type: 'freecell', index: i};
                    }
                }
                return null;
            }
            
            findHomeCellTarget(cardData) {
                return {type: 'home', index: cardData.suit};
            }
            
            findCardPosition(cardElement) {
                const cardData = this.getCardData(cardElement);
                
                // í”„ë¦¬ì…€ì—ì„œ ì°¾ê¸°
                for (let i = 0; i < 4; i++) {
                    if (this.freeCells[i] && this.cardsEqual(this.freeCells[i], cardData)) {
                        return {type: 'freecell', index: i};
                    }
                }
                
                // ì»¬ëŸ¼ì—ì„œ ì°¾ê¸°
                for (let col = 0; col < 8; col++) {
                    for (let row = 0; row < this.columns[col].length; row++) {
                        if (this.cardsEqual(this.columns[col][row], cardData)) {
                            return {type: 'column', column: col, row: row};
                        }
                    }
                }
                
                return null;
            }
            
            findCardPositionByElement(cardElement) {
                // DOM ìš”ì†Œì˜ ì‹¤ì œ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ìœ„ì¹˜ ì°¾ê¸°
                
                // í”„ë¦¬ì…€ì—ì„œ ì°¾ê¸°
                const freecellParent = cardElement.closest('.cell[data-type="freecell"]');
                if (freecellParent) {
                    const index = parseInt(freecellParent.dataset.index);
                    return {type: 'freecell', index: index};
                }
                
                // ì»¬ëŸ¼ì—ì„œ ì°¾ê¸°
                const columnParent = cardElement.closest('.column');
                if (columnParent) {
                    const columnIndex = parseInt(columnParent.dataset.column);
                    const allCardsInColumn = Array.from(columnParent.querySelectorAll('.card'));
                    const cardIndex = allCardsInColumn.indexOf(cardElement);
                    
                    if (cardIndex !== -1) {
                        return {type: 'column', column: columnIndex, row: cardIndex};
                    }
                }
                
                // fallback: ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
                return this.findCardPosition(cardElement);
            }
            
            getCardData(cardElement) {
                const img = cardElement.querySelector('img');
                const src = img.src;
                const filename = src.split('/').pop();
                const [suit, value] = filename.replace('.png', '').split('-');
                return {
                    suit: suit,
                    value: value,
                    color: suit === 'hearts' || suit === 'diamonds' ? 'red' : 'black',
                    number: this.cardValues[value]
                };
            }
            
            cardsEqual(card1, card2) {
                return card1.suit === card2.suit && card1.value === card2.value;
            }
            
            canPickUpCard(position) {
                if (position.type === 'freecell') {
                    return true;
                } else if (position.type === 'column') {
                    // ì„ íƒí•œ ì¹´ë“œë¶€í„° ë§¨ ì•„ë˜ê¹Œì§€ê°€ ì˜¬ë°”ë¥¸ ìˆœì„œì¸ì§€ í™•ì¸
                    return this.isValidSequence(position.column, position.row);
                }
                return false;
            }
            
            isValidSequence(columnIndex, startRow) {
                const column = this.columns[columnIndex];
                
                for (let i = startRow; i < column.length - 1; i++) {
                    const currentCard = column[i];
                    const nextCard = column[i + 1];
                    
                    // ìƒ‰ê¹”ì´ ë²ˆê°ˆì•„ê°€ê³  ìˆ«ìê°€ ë‚´ë¦¼ì°¨ìˆœì´ì–´ì•¼ í•¨
                    if (currentCard.color === nextCard.color || 
                        currentCard.number !== nextCard.number + 1) {
                        return false;
                    }
                }
                return true;
            }
            
            findDropTarget(x, y) {
                // ë“œë˜ê·¸ ì¤‘ì¸ ì¹´ë“œë“¤ì„ ì„ì‹œë¡œ ìˆ¨ê¸°ê¸°
                const draggedElements = this.draggedCardElements || [];
                const originalPointerEvents = [];
                
                draggedElements.forEach((el, index) => {
                    originalPointerEvents[index] = el.style.pointerEvents;
                    el.style.pointerEvents = 'none';
                });
                
                const element = document.elementFromPoint(x, y);
                
                // ì›ë˜ ìƒíƒœë¡œ ë³µì›
                draggedElements.forEach((el, index) => {
                    el.style.pointerEvents = originalPointerEvents[index];
                });
                
                if (!element) return null;
                
                // ì…€ ì²´í¬
                const cell = element.closest('.cell');
                if (cell) {
                    const target = {
                        type: cell.dataset.type,
                        index: cell.dataset.index ? parseInt(cell.dataset.index) : cell.dataset.suit
                    };
                    return target;
                }
                
                // ì»¬ëŸ¼ ì²´í¬
                const column = element.closest('.column');
                if (column) {
                    const target = {
                        type: 'column',
                        index: parseInt(column.dataset.column)
                    };
                    return target;
                }
                
                return null;
            }
            
            canDropCard(from, to) {
                const cards = this.getCardFromPosition(from);
                if (!cards || cards.length === 0) {
                    return false;
                }
                
                const topCard = cards[0]; // ë§¨ ìœ„ ì¹´ë“œë§Œ ì²´í¬
                
                if (to.type === 'freecell') {
                    // í”„ë¦¬ì…€ì—ëŠ” ì¹´ë“œ 1ì¥ë§Œ ë†“ì„ ìˆ˜ ìˆìŒ
                    if (cards.length > 1) {
                        return false;
                    }
                    const canDrop = this.freeCells[to.index] === null;
                    return canDrop;
                } else if (to.type === 'home') {
                    // í™ˆì…€ì—ëŠ” ì¹´ë“œ 1ì¥ë§Œ ë†“ì„ ìˆ˜ ìˆìŒ
                    if (cards.length > 1) {
                        return false;
                    }
                    const stack = this.homeCells[to.index];
                    if (topCard.suit !== to.index) return false;
                    
                    if (stack.length === 0) {
                        return topCard.value === 'ace';
                    } else {
                        const homeTopCard = stack[stack.length - 1];
                        return topCard.number === homeTopCard.number + 1;
                    }
                                } else if (to.type === 'column') {
                    const column = this.columns[to.index];
                    
                    if (column.length === 0) {
                        return true;
                    }
                    
                    const columnTopCard = column[column.length - 1];
                    const canDrop = topCard.color !== columnTopCard.color && topCard.number === columnTopCard.number - 1;
                    return canDrop;
                }
                
                return false;
            }
            
            getCardFromPosition(position) {
                if (position.type === 'freecell') {
                    const card = this.freeCells[position.index];
                    return card ? [card] : [];
                } else if (position.type === 'column') {
                    // ì„ íƒí•œ ì¹´ë“œë¶€í„° ë§¨ ì•„ë˜ê¹Œì§€ ëª¨ë“  ì¹´ë“œ ë°˜í™˜
                    const column = this.columns[position.column];
                    if (position.row >= 0 && position.row < column.length) {
                        return column.slice(position.row);
                    }
                    return [];
                }
                return [];
            }
            
            getTopCardFromPosition(position) {
                if (position.type === 'freecell') {
                    return this.freeCells[position.index];
                } else if (position.type === 'column') {
                    return this.columns[position.column][position.row];
                }
                return null;
            }
            
            moveCard(from, to) {
                const cards = this.getCardFromPosition(from);
                
                // ì¹´ë“œ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                if (!cards || cards.length === 0 || !cards[0]) {
                    return;
                }
                
                // ì›ë˜ ìœ„ì¹˜ì—ì„œ ì œê±°
                if (from.type === 'freecell') {
                    this.freeCells[from.index] = null;
                } else if (from.type === 'column') {
                    // ì„ íƒí•œ ì¹´ë“œë¶€í„° ë§¨ ì•„ë˜ê¹Œì§€ ëª¨ë‘ ì œê±°
                    this.columns[from.column].splice(from.row, cards.length);
                }
                
                // ìƒˆ ìœ„ì¹˜ì— ì¶”ê°€
                if (to.type === 'freecell') {
                    this.freeCells[to.index] = cards[0];
                } else if (to.type === 'home') {
                    this.homeCells[to.index].push(cards[0]);
                } else if (to.type === 'column') {
                    // ì—¬ëŸ¬ ì¹´ë“œë¥¼ ìˆœì„œëŒ€ë¡œ ì¶”ê°€
                    this.columns[to.index].push(...cards);
                }
            }
            

            
            clearDropTargets() {
                document.querySelectorAll('.drop-target').forEach(el => {
                    el.classList.remove('drop-target');
                });
            }
            
            render() {
                this.renderFreeCells();
                this.renderHomeCells();
                this.renderColumns();
            }
            
            renderFreeCells() {
                for (let i = 0; i < 4; i++) {
                    const cell = document.querySelector(`[data-type="freecell"][data-index="${i}"]`);
                    if (this.freeCells[i]) {
                        cell.innerHTML = '';
                        const cardElement = this.createCardElement(this.freeCells[i]);
                        
                        // createCardElementê°€ nullì„ ë°˜í™˜í•œ ê²½ìš° ì²˜ë¦¬
                        if (!cardElement) {
                            cell.innerHTML = '';
                            return;
                        }
                        
                        // ë“œë˜ê·¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì™„ì „ ì œê±°
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('pointer-events');
                        cardElement.classList.remove('dragging');
                        
                        // í”„ë¦¬ì…€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
                        cardElement.style.position = 'relative';
                        cardElement.style.margin = '0';
                        
                        cell.appendChild(cardElement);
                    } else {
                        cell.innerHTML = '';
                    }
                }
            }
            
            renderHomeCells() {
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                const symbols = {hearts: 'â™¥', diamonds: 'â™¦', clubs: 'â™£', spades: 'â™ '};
                
                suits.forEach(suit => {
                    const cell = document.querySelector(`[data-type="home"][data-suit="${suit}"]`);
                    const stack = this.homeCells[suit];
                    
                    if (stack.length > 0) {
                        cell.innerHTML = '';
                        const cardElement = this.createCardElement(stack[stack.length - 1]);
                        
                        // createCardElementê°€ nullì„ ë°˜í™˜í•œ ê²½ìš° ì²˜ë¦¬
                        if (!cardElement) {
                            cell.innerHTML = symbols[suit];
                            return;
                        }
                        
                        // ë“œë˜ê·¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì™„ì „ ì œê±°
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('pointer-events');
                        cardElement.classList.remove('dragging');
                        
                        // í™ˆì…€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
                        cardElement.style.position = 'relative';
                        cardElement.style.margin = '0';
                        
                        cell.appendChild(cardElement);
                    } else {
                        cell.innerHTML = symbols[suit];
                    }
                });
            }
            
            renderColumns() {
                for (let col = 0; col < 8; col++) {
                    const column = document.querySelector(`[data-column="${col}"]`);
                    column.innerHTML = '';
                    
                    this.columns[col].forEach((card, index) => {
                        const cardElement = this.createCardElement(card);
                        
                        // createCardElementê°€ nullì„ ë°˜í™˜í•œ ê²½ìš° ì²˜ë¦¬
                        if (!cardElement) {
                            return;
                        }
                        
                        // ë“œë˜ê·¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì™„ì „ ì œê±° í›„ ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ ì ìš©
                        cardElement.style.removeProperty('position');
                        cardElement.style.removeProperty('left');
                        cardElement.style.removeProperty('top');
                        cardElement.style.removeProperty('transform');
                        cardElement.style.removeProperty('z-index');
                        cardElement.style.removeProperty('pointer-events');
                        cardElement.classList.remove('dragging');
                        
                        // ì»¬ëŸ¼ì—ì„œ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ ì„¤ì •
                        cardElement.style.position = 'absolute';
                        cardElement.style.left = '50%';
                        cardElement.style.transform = 'translateX(-50%)';
                        cardElement.style.top = `${index * 30}px`;
                        
                        column.appendChild(cardElement);
                    });
                }
            }
            
            createCardElement(card) {
                // ì¹´ë“œ ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”
                if (!card) {
                    return null;
                }
                
                if (!card.suit || !card.value) {
                    return null;
                }
                
                try {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    
                    const img = document.createElement('img');
                    img.src = `../solitaire/cards/${card.suit}-${card.value}.png`;
                    img.alt = `${card.value} of ${card.suit}`;
                    
                    cardDiv.appendChild(img);
                    return cardDiv;
                } catch (error) {
                    return null;
                }
            }
            
            checkAutoComplete() {
                // 4ê°œ ë¬´ëŠ¬ ëª¨ë‘ê°€ ì™„ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (this.areAllSuitsCompleted()) {
                    this.autoMoveAllCardsToHome();
                }
            }
            
            checkWin() {
                // 4ê°œ ë¬´ëŠ¬ ëª¨ë‘ê°€ ì™„ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (this.areAllSuitsCompleted()) {
                    this.autoMoveAllCardsToHome();
                }
            }
            
            isGameWon() {
                // ëª¨ë“  í™ˆì…€ì´ ì™„ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                return suits.every(suit => this.homeCells[suit].length === 13);
            }
            
            playWinAnimation() {
                
                // í™ˆì…€ì˜ ëª¨ë“  ì¹´ë“œì— ìŠ¹ë¦¬ íš¨ê³¼ ì ìš©
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                suits.forEach((suit, suitIndex) => {
                    const homeCell = document.querySelector(`[data-type="home"][data-suit="${suit}"]`);
                    if (homeCell) {
                        const card = homeCell.querySelector('.card');
                        if (card) {
                            // ìˆœì°¨ì ìœ¼ë¡œ ìŠ¹ë¦¬ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
                            setTimeout(() => {
                                card.style.transition = 'transform 0.5s ease-out';
                                card.style.transform = 'scale(1.1) rotate(5deg)';
                                
                                setTimeout(() => {
                                    card.style.transform = 'scale(1) rotate(0deg)';
                                }, 500);
                            }, suitIndex * 100);
                        }
                    }
                });
                
                // ìŠ¹ë¦¬ ë©”ì‹œì§€ í‘œì‹œ
                setTimeout(() => {
                    this.showWinMessage();
                }, 1000);
            }
            
            showWinMessage() {
                const winMessage = document.querySelector('.win-message');
                if (winMessage) {
                    winMessage.style.display = 'block';
                    winMessage.innerHTML = `
                        <h2>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
                        <p>í”„ë¦¬ì…€ì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!</p>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button onclick="newGame(); this.parentElement.parentElement.style.display='none';" style="padding: 10px 20px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer;">ìƒˆë¡œí•˜ê¸°</button>
                            <button onclick="window.top.location.href='../../index.html'" style="padding: 10px 20px; border: none; border-radius: 5px; background: #2196F3; color: white; cursor: pointer;">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                        </div>
                    `;
                }
            }
            
            areAllSuitsCompleted() {
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                
                for (let suit of suits) {
                    // ê° ë¬´ëŠ¬ë³„ë¡œ A~Kê¹Œì§€ ëª¨ë“  ì¹´ë“œê°€ ê²Œì„íŒì— ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ìˆëŠ”ì§€ í™•ì¸
                    if (!this.isSuitCompleted(suit)) {
                        return false;
                    }
                }
                
                return true;
            }
            
            isSuitCompleted(suit) {
                const homeStack = this.homeCells[suit];
                const allCards = this.getAllCardsOfSuit(suit);
                
                // í•´ë‹¹ ë¬´ëŠ¬ì˜ ì¹´ë“œê°€ 13ì¥ì´ ì•„ë‹ˆë©´ ì™„ì„±ë˜ì§€ ì•ŠìŒ
                if (allCards.length !== 13) return false;
                
                // Aë¶€í„° Kê¹Œì§€ ìˆœì„œëŒ€ë¡œ ìˆëŠ”ì§€ í™•ì¸
                for (let i = 0; i < 13; i++) {
                    const expectedNumber = i + 1; // 1(A), 2, 3, ..., 13(K)
                    
                    if (!allCards.find(card => card.number === expectedNumber)) {
                        return false;
                    }
                }
                
                // ëª¨ë“  ì¹´ë“œê°€ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ìŒ“ì¼ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
                return this.canMoveAllCardsToHome(suit);
            }
            
            getAllCardsOfSuit(suit) {
                const cards = [];
                
                // í™ˆì…€ì—ì„œ ì°¾ê¸°
                cards.push(...this.homeCells[suit]);
                
                // í”„ë¦¬ì…€ì—ì„œ ì°¾ê¸°
                for (let cell of this.freeCells) {
                    if (cell && cell.suit === suit) {
                        cards.push(cell);
                    }
                }
                
                // ì»¬ëŸ¼ì—ì„œ ì°¾ê¸°
                for (let column of this.columns) {
                    for (let card of column) {
                        if (card.suit === suit) {
                            cards.push(card);
                        }
                    }
                }
                
                return cards;
            }
            
            canMoveAllCardsToHome(suit) {
                const homeStack = this.homeCells[suit];
                const expectedNext = homeStack.length + 1; // í™ˆì…€ì— ë“¤ì–´ê°€ì•¼ í•  ë‹¤ìŒ ë²ˆí˜¸
                
                // í”„ë¦¬ì…€ì—ì„œ ë‹¤ìŒ ì¹´ë“œ ì°¾ê¸°
                for (let i = 0; i < 4; i++) {
                    const cell = this.freeCells[i];
                    if (cell && cell.suit === suit && cell.number === expectedNext) {
                        return true;
                    }
                }
                
                // ì»¬ëŸ¼ì—ì„œ ë‹¤ìŒ ì¹´ë“œ ì°¾ê¸° (ë§¨ ìœ„ ì¹´ë“œë§Œ)
                for (let column of this.columns) {
                    if (column.length > 0) {
                        const topCard = column[column.length - 1];
                        if (topCard.suit === suit && topCard.number === expectedNext) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            autoMoveAllCardsToHome() {
                // ì´ë¯¸ ìë™ì™„ì„± ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
                if (this.isAutoCompleting) {
                    return;
                }
                
                this.isAutoCompleting = true;
                
                // ëª¨ë“  ì¹´ë“œë¥¼ ìˆ˜ì§‘í•˜ì—¬ ìˆœì„œëŒ€ë¡œ ì´ë™í•  ì¹´ë“œ ëª©ë¡ ìƒì„±
                const cardsToMove = this.collectAllMovableCards();
                
                if (cardsToMove.length === 0) {
                    this.isAutoCompleting = false;
                    return;
                }
                
                // ìˆœì°¨ì ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜ ì´ë™
                this.animateCardsSequentially(cardsToMove, 0);
            }
            
            collectAllMovableCards() {
                const cardsToMove = [];
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                
                // ê° ë¬´ëŠ¬ë³„ë¡œ ì´ë™ ê°€ëŠ¥í•œ ì¹´ë“œë“¤ì„ ìˆ˜ì§‘
                for (let suit of suits) {
                    const homeStack = this.homeCells[suit];
                    const expectedNext = homeStack.length + 1;
                    
                    // í™ˆì…€ì´ ì´ë¯¸ ì™„ì„±ë˜ì—ˆìœ¼ë©´ ìŠ¤í‚µ
                    if (homeStack.length === 13) continue;
                    
                    let foundCard = false;
                    
                    // í”„ë¦¬ì…€ì—ì„œ ë¨¼ì € ì°¾ê¸° (ìš°ì„ ìˆœìœ„)
                    for (let i = 0; i < 4; i++) {
                        const cell = this.freeCells[i];
                        if (cell && cell.suit === suit && cell.number === expectedNext) {
                            cardsToMove.push({
                                card: cell,
                                from: {type: 'freecell', index: i},
                                to: {type: 'home', index: suit},
                                suit: suit,
                                number: cell.number
                            });
                            foundCard = true;
                            break; // ê°™ì€ ë¬´ëŠ¬ì˜ ê°™ì€ ìˆ«ìëŠ” í•˜ë‚˜ë§Œ ì°¾ê¸°
                        }
                    }
                    
                    // í”„ë¦¬ì…€ì—ì„œ ëª» ì°¾ì•˜ìœ¼ë©´ ì»¬ëŸ¼ì—ì„œ ì°¾ê¸°
                    if (!foundCard) {
                        for (let col = 0; col < 8; col++) {
                            const column = this.columns[col];
                            if (column.length > 0) {
                                // ì»¬ëŸ¼ì—ì„œ í•´ë‹¹ ì¹´ë“œì˜ ì •í™•í•œ ìœ„ì¹˜ ì°¾ê¸°
                                for (let row = column.length - 1; row >= 0; row--) {
                                    const card = column[row];
                                    if (card.suit === suit && card.number === expectedNext) {
                                        cardsToMove.push({
                                            card: card,
                                            from: {type: 'column', column: col, row: row},
                                            to: {type: 'home', index: suit},
                                            suit: suit,
                                            number: card.number
                                        });
                                        foundCard = true;
                                        break; // ê°™ì€ ë¬´ëŠ¬ì˜ ê°™ì€ ìˆ«ìëŠ” í•˜ë‚˜ë§Œ ì°¾ê¸°
                                    }
                                }
                                if (foundCard) break; // ì»¬ëŸ¼ì—ì„œ ì°¾ì•˜ìœ¼ë©´ ë‹¤ìŒ ì»¬ëŸ¼ ê²€ìƒ‰ ì¤‘ë‹¨
                            }
                        }
                    }
                }
                
                // ëª¨ë“  ì¹´ë“œë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ë§Œë“¤ì–´ì„œ ì—°ì† ì´ë™ (ë¬´ëŠ¬ êµ¬ë¶„ ì—†ì´)
                const sortedCards = cardsToMove.sort((a, b) => {
                    // ë¨¼ì € ë¬´ëŠ¬ ìˆœì„œ
                    const suitOrder = ['hearts', 'diamonds', 'clubs', 'spades'];
                    const suitA = suitOrder.indexOf(a.suit);
                    const suitB = suitOrder.indexOf(b.suit);
                    
                    if (suitA !== suitB) {
                        return suitA - suitB;
                    }
                    
                    // ê°™ì€ ë¬´ëŠ¬ ë‚´ì—ì„œëŠ” ìˆ«ì ìˆœì„œ
                    return a.number - b.number;
                });
                
                return sortedCards;
            }
            
            animateCardsSequentially(cardsToMove, index) {
                if (index >= cardsToMove.length) {
                    this.render();
                    this.isAutoCompleting = false;
                    
                    // ìë™ì™„ì„± ì™„ë£Œ í›„ ìŠ¹ë¦¬ ì²´í¬
                    if (this.isGameWon()) {
                        this.playWinAnimation();
                    }
                    return;
                }
                
                const cardInfo = cardsToMove[index];
                
                // ì›ë³¸ ì¹´ë“œ ì—˜ë¦¬ë¨¼íŠ¸ ì°¾ê¸°
                const cardElement = this.findCardElement(cardInfo.card, cardInfo.from);
                
                if (cardElement) {
                    // ì›ë³¸ ì¹´ë“œë¥¼ ì§ì ‘ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì´ë™
                    this.animateOriginalCard(cardElement, cardInfo.from, cardInfo.to, () => {
                        // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ë‹¤ìŒ ì¹´ë“œ ì‹œì‘
                        setTimeout(() => {
                            this.animateCardsSequentially(cardsToMove, index + 1);
                        }, 100);
                    });
                    
                    // ì¹´ë“œê°€ 10% ì§„í–‰ë  ë•Œ ë‹¤ìŒ ì¹´ë“œ ì‹œì‘ (ê²¹ì³ì„œ ì´ë™)
                    setTimeout(() => {
                        // ë‹¤ìŒ ì¹´ë“œê°€ ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ì‹œì‘
                        if (index + 1 < cardsToMove.length) {
                            this.animateCardsSequentially(cardsToMove, index + 1);
                        }
                    }, 100);
                } else {
                    // ì¹´ë“œ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì´ë™
                    this.moveCard(cardInfo.from, cardInfo.to);
                    this.render();
                    // ë‹¤ìŒ ì¹´ë“œë¡œ ì¦‰ì‹œ ì´ë™
                    this.animateCardsSequentially(cardsToMove, index + 1);
                }
            }
            
            moveNextCardToHome(suit) {
                const homeStack = this.homeCells[suit];
                const expectedNext = homeStack.length + 1;
                
                // í™ˆì…€ì´ ì´ë¯¸ ì™„ì„±ë˜ì—ˆìœ¼ë©´ ìŠ¤í‚µ
                if (homeStack.length === 13) return false;
                
                // í”„ë¦¬ì…€ì—ì„œ ì°¾ê¸°
                for (let i = 0; i < 4; i++) {
                    const cell = this.freeCells[i];
                    if (cell && cell.suit === suit && cell.number === expectedNext) {
                        this.homeCells[suit].push(cell);
                        this.freeCells[i] = null;
                        return true;
                    }
                }
                
                // ì»¬ëŸ¼ì—ì„œ ì°¾ê¸° (ë§¨ ìœ„ ì¹´ë“œë§Œ)
                for (let col = 0; col < 8; col++) {
                    const column = this.columns[col];
                    if (column.length > 0) {
                        const topCard = column[column.length - 1];
                        if (topCard.suit === suit && topCard.number === expectedNext) {
                            this.homeCells[suit].push(column.pop());
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            findCompletedSequence(column) {
                if (column.length < 13) return {sequence: [], startIndex: -1}; // 13ì¥ ë¯¸ë§Œì´ë©´ ì™„ì „í•œ ì‹œí€€ìŠ¤ ë¶ˆê°€ëŠ¥
                
                // ê° ë¬´ëŠ¬ë³„ë¡œ ì™„ì „í•œ A~K ì‹œí€€ìŠ¤ ì°¾ê¸°
                const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                
                for (let suit of suits) {
                    const homeStack = this.homeCells[suit];
                    
                    // í™ˆì…€ì´ ì´ë¯¸ ì™„ì„±ë˜ì–´ ìˆìœ¼ë©´ ìŠ¤í‚µ
                    if (homeStack.length === 13) continue;
                    
                    // ì»¬ëŸ¼ì—ì„œ A(1)ë¶€í„° K(13)ê¹Œì§€ ì™„ì „í•œ ì‹œí€€ìŠ¤ ì°¾ê¸°
                    for (let startIdx = 0; startIdx <= column.length - 13; startIdx++) {
                        // Aë¶€í„° ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
                        if (column[startIdx].suit === suit && column[startIdx].value === 'ace') {
                            const sequence = [];
                            let isComplete = true;
                            
                            // Aë¶€í„° Kê¹Œì§€ 13ì¥ì´ ì—°ì†ìœ¼ë¡œ ìˆëŠ”ì§€ í™•ì¸
                            for (let i = 0; i < 13; i++) {
                                const cardIndex = startIdx + i;
                                if (cardIndex >= column.length) {
                                    isComplete = false;
                                    break;
                                }
                                
                                const card = column[cardIndex];
                                const expectedNumber = i + 1; // 1(A), 2, 3, ..., 13(K)
                                
                                if (card.suit === suit && card.number === expectedNumber) {
                                    sequence.push(card);
                                } else {
                                    isComplete = false;
                                    break;
                                }
                            }
                            
                            // ì™„ì „í•œ A~K ì‹œí€€ìŠ¤ê°€ ë°œê²¬ë˜ë©´ ë°˜í™˜
                            if (isComplete && sequence.length === 13) {
                                return {sequence, startIndex: startIdx};
                            }
                        }
                    }
                }
                
                return {sequence: [], startIndex: -1};
            }
            
            moveSequenceToHome(columnIndex, sequence, startIndex) {
                const suit = sequence[0].suit;
                
                // ì»¬ëŸ¼ì—ì„œ ì œê±° (startIndexë¶€í„° sequence.lengthë§Œí¼)
                this.columns[columnIndex].splice(startIndex, sequence.length);
                
                // í™ˆì…€ì— ì¶”ê°€
                for (let card of sequence) {
                    this.homeCells[suit].push(card);
                }
            }

            autoMove() {
                // ì´ë™í•  ìˆ˜ ìˆëŠ” ì¹´ë“œë“¤ì„ ì°¾ì•„ì„œ ìˆœì°¨ì ìœ¼ë¡œ ì´ë™
                const moveableCards = [];
                
                // ì»¬ëŸ¼ì—ì„œ í™ˆì…€ë¡œ ì´ë™ ê°€ëŠ¥í•œ ì¹´ë“œë“¤ ì°¾ê¸°
                for (let col = 0; col < 8; col++) {
                    if (this.columns[col].length > 0) {
                        const card = this.columns[col][this.columns[col].length - 1];
                        const homeStack = this.homeCells[card.suit];
                        
                        if ((homeStack.length === 0 && card.value === 'ace') ||
                            (homeStack.length > 0 && homeStack[homeStack.length - 1].number + 1 === card.number)) {
                            
                            // ì¹´ë“œì˜ ì •í™•í•œ ìœ„ì¹˜ ì°¾ê¸°
                            const cardRow = this.findCardRowInColumn(col, card);
                            moveableCards.push({
                                card: card,
                                fromPosition: {type: 'column', column: col, row: cardRow},
                                toPosition: {type: 'home', index: card.suit},
                                priority: card.value === 'ace' ? 1 : 2 // ì—ì´ìŠ¤ ìš°ì„ 
                            });
                        }
                    }
                }
                
                // í”„ë¦¬ì…€ì—ì„œ í™ˆì…€ë¡œ ì´ë™ ê°€ëŠ¥í•œ ì¹´ë“œë“¤ ì°¾ê¸°
                for (let i = 0; i < 4; i++) {
                    if (this.freeCells[i]) {
                        const card = this.freeCells[i];
                        const homeStack = this.homeCells[card.suit];
                        
                        if ((homeStack.length === 0 && card.value === 'ace') ||
                            (homeStack.length > 0 && homeStack[homeStack.length - 1].number + 1 === card.number)) {
                            
                            moveableCards.push({
                                card: card,
                                fromPosition: {type: 'freecell', index: i},
                                toPosition: {type: 'home', index: card.suit},
                                priority: card.value === 'ace' ? 1 : 2 // ì—ì´ìŠ¤ ìš°ì„ 
                            });
                        }
                    }
                }
                
                // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì •ë ¬ (ì—ì´ìŠ¤ ë¨¼ì €, ê·¸ ë‹¤ìŒ ìˆ«ì ìˆœ)
                moveableCards.sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    return a.card.number - b.card.number;
                });
                
                // ìˆœì°¨ì ìœ¼ë¡œ ì´ë™
                if (moveableCards.length > 0) {
                    this.moveCardsSequentially(moveableCards, 0);
                }
            }
            
            moveCardsSequentially(moveableCards, index) {
                if (index >= moveableCards.length) return;
                
                const moveData = moveableCards[index];
                const cardElement = this.findCardElement(moveData.card, moveData.fromPosition);
                
                if (cardElement) {
                    this.animateCardMove(cardElement, moveData.fromPosition, moveData.toPosition, () => {
                        // ë‹¤ìŒ ì¹´ë“œ ì´ë™ (300ms í›„)
                        setTimeout(() => {
                            this.moveCardsSequentially(moveableCards, index + 1);
                        }, 300);
                    });
                } else {
                    // ì• ë‹ˆë©”ì´ì…˜ ì‹¤íŒ¨ì‹œ ì¦‰ì‹œ ì´ë™í•˜ê³  ë‹¤ìŒìœ¼ë¡œ
                    this.moveCard(moveData.fromPosition, moveData.toPosition);
                    this.render();
                    setTimeout(() => {
                        this.moveCardsSequentially(moveableCards, index + 1);
                    }, 100);
                }
            }
            
            findCardElement(cardData, position) {
                try {
                    if (position.type === 'column') {
                        const column = document.querySelector(`[data-column="${position.column}"]`);
                        if (!column) return null;
                        
                        const cardElements = Array.from(column.querySelectorAll('.card'));
                        
                        // ì •í™•í•œ row ìœ„ì¹˜ì˜ ì¹´ë“œ ì°¾ê¸° (ìë™ì™„ì„±ì—ì„œëŠ” í•­ìƒ ë§¨ ìœ„ ì¹´ë“œ)
                        if (position.row !== undefined && position.row >= 0 && position.row < cardElements.length) {
                            const targetCardElement = cardElements[position.row];
                            if (targetCardElement) {
                                const elementCardData = this.getCardData(targetCardElement);
                                if (this.cardsEqual(elementCardData, cardData)) {
                                    return targetCardElement;
                                }
                            }
                        }
                        
                        // fallback: ë§¨ ìœ„ ì¹´ë“œì—ì„œ ì°¾ê¸°
                        const lastCardElement = cardElements[cardElements.length - 1];
                        if (lastCardElement) {
                            const elementCardData = this.getCardData(lastCardElement);
                            if (this.cardsEqual(elementCardData, cardData)) {
                                return lastCardElement;
                            }
                        }
                    } else if (position.type === 'freecell') {
                        const freecell = document.querySelector(`.cell[data-type="freecell"][data-index="${position.index}"]`);
                        if (!freecell) return null;
                        
                        const cardElement = freecell.querySelector('.card');
                        if (cardElement) {
                            const elementCardData = this.getCardData(cardElement);
                            if (this.cardsEqual(elementCardData, cardData)) {
                                return cardElement;
                            }
                        }
                    }
                } catch (error) {
                    // ë¬´ì‹œ
                }
                
                return null;
            }
            
            isCardAtPosition(cardData, position) {
                try {
                    if (position.type === 'column') {
                        const column = this.columns[position.column];
                        if (position.row >= 0 && position.row < column.length) {
                            return this.cardsEqual(column[position.row], cardData);
                        }
                        return false;
                    } else if (position.type === 'freecell') {
                        const cellCard = this.freeCells[position.index];
                        return cellCard && this.cardsEqual(cellCard, cardData);
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            }
            
            checkWin() {
                // ìŠ¹ë¦¬ ì²´í¬ëŠ” isGameWon()ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œê±°
            }
            
            newGame() {
                this.freeCells = [null, null, null, null];
                this.homeCells = {hearts: [], diamonds: [], clubs: [], spades: []};
                this.columns = [[], [], [], [], [], [], [], []];
                this.draggedCard = null;
                this.draggedFrom = null;
                document.getElementById('winMessage').style.display = 'none';
                this.init();
            }
        }
        
        // ê²Œì„ ì‹œì‘
        const game = new FreeCell();
        
        // ì „ì—­ í•¨ìˆ˜ë“¤
        function newGame() {
            game.newGame();
        }
        
        function autoMove() {
            game.autoMove();
        }
    </script>
</body>
</html>